<!doctype html><html lang=en><meta charset=utf-8><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"http:\/\/blog.casavian.eu\/"},"articleSection":"post","name":"Meta-pipelines - Part 2 - Dockerize the agent","headline":"Meta-pipelines - Part 2 - Dockerize the agent","description":"Notes and considerations of small venetian guy on DevOps tools, architecture, development and other paraphernalia.","inLanguage":"en","author":"Giulio Vian","creator":"Giulio Vian","publisher":"Giulio Vian","accountablePerson":"Giulio Vian","copyrightHolder":"Giulio Vian","copyrightYear":"2019","datePublished":"2019-08-30T00:00:00Z","dateModified":"2019-08-30T00:00:00Z","url":"\/2019\/08\/30\/meta-pipelines-part-2-dockerize-the-agent\/","wordCount":"1776","keywords":["Build","Pipelines","Azure DevOps","Docker","Blog"]}</script><title>Meta-pipelines - Part 2 - Dockerize the agent &ndash; Giulio Vian's Blog!</title><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=description content="Notes and considerations of small venetian guy on DevOps tools, architecture, development and other paraphernalia."><meta name=author content="Giulio Vian"><link rel=icon href=/favicon.ico><meta itemprop=name content="Meta-pipelines - Part 2 - Dockerize the agent"><meta itemprop=description content="In the previous instalment we setup a couple of machines to run Docker and host docker containers. In this post, we will explore the structure of a Dockerfile for Azure Pipelines/TFS Agent.
 There is a notable difference between Azure DevOps Service and Server in terms of handling agent updates. The first part of this article can be used in air-gapped environments.
 If you need a primer on Docker there is plenty of resources, from the excellent The Docker Book &nbsp;  to the official documentation &nbsp; , Pluralsight courses, etc."><meta itemprop=datePublished content="2019-08-30T00:00:00+00:00"><meta itemprop=dateModified content="2019-08-30T00:00:00+00:00"><meta itemprop=wordCount content="1776"><meta itemprop=image content="http://blog.casavian.eu/2019/08/30/meta-pipelines-part-2-dockerize-the-agent/feature-banner.jpg"><meta itemprop=keywords content="Build,Pipelines,Azure DevOps,Docker,"><meta property="og:title" content="Meta-pipelines - Part 2 - Dockerize the agent"><meta property="og:description" content="In the previous instalment we setup a couple of machines to run Docker and host docker containers. In this post, we will explore the structure of a Dockerfile for Azure Pipelines/TFS Agent.
 There is a notable difference between Azure DevOps Service and Server in terms of handling agent updates. The first part of this article can be used in air-gapped environments.
 If you need a primer on Docker there is plenty of resources, from the excellent The Docker Book &nbsp;  to the official documentation &nbsp; , Pluralsight courses, etc."><meta property="og:type" content="article"><meta property="og:url" content="http://blog.casavian.eu/2019/08/30/meta-pipelines-part-2-dockerize-the-agent/"><meta property="og:image" content="http://blog.casavian.eu/2019/08/30/meta-pipelines-part-2-dockerize-the-agent/feature-banner.jpg"><meta property="article:published_time" content="2019-08-30T00:00:00+00:00"><meta property="article:modified_time" content="2019-08-30T00:00:00+00:00"><meta property="og:site_name" content="Giulio Vian's Blog!"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="http://blog.casavian.eu/2019/08/30/meta-pipelines-part-2-dockerize-the-agent/feature-banner.jpg"><meta name=twitter:title content="Meta-pipelines - Part 2 - Dockerize the agent"><meta name=twitter:description content="In the previous instalment we setup a couple of machines to run Docker and host docker containers. In this post, we will explore the structure of a Dockerfile for Azure Pipelines/TFS Agent.
 There is a notable difference between Azure DevOps Service and Server in terms of handling agent updates. The first part of this article can be used in air-gapped environments.
 If you need a primer on Docker there is plenty of resources, from the excellent The Docker Book &nbsp;  to the official documentation &nbsp; , Pluralsight courses, etc."><meta name=twitter:site content="@giulio_vian"><link rel=alternate href=/index.xml type=application/rss+xml title="Giulio Vian's Blog!"><link rel=stylesheet href=/css/vendor.min.95b0b4c4607aec507f0fc9d9c36a12a4613ccac06f9423caa43e265cb58eb5f90709388cc0fa166ac3ca836b4163e6d0569b8b86065d9cabdf223c5ea9a63b08.css integrity="sha512-lbC0xGB67FB/D8nZw2oSpGE8ysBvlCPKpD4mXLWOtfkHCTiMwPoWasPKg2tBY+bQVpuLhgZdnKvfIjxeqaY7CA=="><link href=http://blog.casavian.eu/css/cookieconsent.min.cd0d0b6e50ff01ff2f3a9a70d7cfb66a7c6cb9acf7a566325568be6d3bd31fc4.css rel=stylesheet type=text/css integrity="sha256-zQ0LblD/Af8vOppw18+2anxsuaz3pWYyVWi+bTvTH8Q=" crossorigin=anonymous><script src=http://blog.casavian.eu/js/cookieconsent.min.e55842a856a6d829feca3c3ad736c136b6c7549e9247274f78aa296259e06e24.js integrity="sha256-5VhCqFam2Cn+yjw61zbBNrbHVJ6SRydPeKopYlngbiQ=" crossorigin=anonymous async></script><script>window.addEventListener("load",function(){window.cookieconsent.initialise({"palette":{"popup":{"background":"#428bca","text":"#ffffff"},"button":{"background":"#f71559"}},"content":{"message":'This website uses cookies.',"dismiss":'Got it!',"link":'Learn more.',"href":"http:\/\/blog.casavian.eu\/page\/privacy-cookies-policy\/"},"position":"bottom-right"})});</script><body><nav class="navbar navbar-light bg-white navbar-expand-lg border-bottom"><div class=container><a class="navbar-brand text-primary" href=/>Giulio Vian's Blog!</a>
<button class="navbar-toggler collapsed" type=button data-toggle=collapse data-target=#navbarCollapse aria-controls=navbarCollapse aria-expanded=false aria-label="Toggle navigation">
<span class=navbar-toggler-icon></span></button><div class="navbar-collapse collapse" id=navbarCollapse><ul class="navbar-nav mr-auto"><li class=nav-item><a class="nav-link text-primary" href=/index.html><i class="fas fa-home"></i>Home</a></li><li class=nav-item><a class="nav-link text-primary" href=/page/about/><i class="fa fa-info-circle"></i>About</a></li><li class=nav-item><a class="nav-link text-primary" href=/page/public-speaking><i class="fa fa-microphone"></i>Speaking</a></li></ul></div></div></nav><main role=main><div class="container mt-3 mb-3"><div class=card><img class=card-img-top src=/2019/08/30/meta-pipelines-part-2-dockerize-the-agent/feature-banner_hu34c3e573966966cb30c13e11fba0381d_392742_1108x0_resize_q75_box.jpg alt="Meta-pipelines - Part 2 - Dockerize the agent" title="Meta-pipelines - Part 2 - Dockerize the agent"><div class=card-body><h1 class=card-title><a href=/2019/08/30/meta-pipelines-part-2-dockerize-the-agent/>Meta-pipelines - Part 2 - Dockerize the agent</a></h1><h6 class="card-subtitle mb-2 text-muted"><i class="fas fa-calendar-day"></i>&nbsp;30 Aug 2019 -
<i class="fas fa-user"></i>&nbsp;Giulio Vian
- <i class="fas fa-clock"></i>&nbsp;~9 Minutes</h6><p class=card-text><p>In the previous instalment we setup a couple of machines to run Docker and host docker containers. In this post, we will explore the structure of a Dockerfile for Azure Pipelines/TFS Agent.</p><blockquote><p>There is a notable difference between Azure DevOps Service and Server in terms of handling agent updates.
The first part of this article can be used in air-gapped environments.</p></blockquote><p>If you need a primer on Docker there is plenty of resources, from the excellent <a href=https://dockerbook.com/ target=_blank rel="noopener noreferrer">The Docker Book
&nbsp;<i class="fas fa-external-link-alt"></i></a> to the <a href=https://docs.docker.com/ target=_blank rel="noopener noreferrer">official documentation
&nbsp;<i class="fas fa-external-link-alt"></i>
</a>, Pluralsight courses, etc.</p><h2 id=dockerfile-for-a-windows-azure-pipelines-agent>Dockerfile for a Windows Azure Pipelines agent</h2><p>This sample Docker file leverages Docker multi-stage build feature to download the Agent and the SDK binaries. Note that the agent version is defined in the Docker file, which works perfectly on the TFS/Azure DevOps Server scenario. More on the Azure DevOps Service scenario later.</p><p>To use a different toolchain, say .Net Core 3.0, you change the section marked <code>toolchain download</code> to download whatever SDK and tool you need to install, and also the <code>toolchain setup</code> section.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Dockerfile data-lang=Dockerfile><span style=color:#75715e># escape=`</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>FROM</span><span style=color:#e6db74> mcr.microsoft.com/windows/servercore:ltsc2019 AS agent</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>SHELL</span> [<span style=color:#e6db74>&#34;powershell&#34;</span>, <span style=color:#e6db74>&#34;-Command&#34;</span>, <span style=color:#e6db74>&#34;$ErrorActionPreference = &#39;Stop&#39;; $ProgressPreference = &#39;SilentlyContinue&#39;;&#34;</span>]<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>ENV</span> AGENT_VERSION 2.154.1<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>ENV</span> AGENT_SHA256 67634CC6B9D0A7F373940F08E6F76FE8A04CE3B765FAF9E693836F35289A08B1<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> Invoke-WebRequest -OutFile agent.zip https://vstsagentpackage.azureedge.net/agent/$env:AGENT_VERSION/vsts-agent-win-x64-$env:AGENT_VERSION.zip; <span style=color:#e6db74>`</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>((</span>Get-FileHash agent.zip -Algorithm sha256<span style=color:#f92672>)</span>.Hash -ne $Env:AGENT_SHA256<span style=color:#f92672>)</span> <span style=color:#f92672>{</span> <span style=color:#e6db74>`</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>        Write-Host <span style=color:#e6db74>&#39;CHECKSUM VERIFICATION FAILED!&#39;</span>; <span style=color:#e6db74>`</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>        exit 1; <span style=color:#e6db74>`</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>    <span style=color:#f92672>}</span>; <span style=color:#e6db74>`</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>    Expand-Archive -Path agent.zip -DestinationPath C:<span style=color:#ae81ff>\B</span>uildAgent ; <span style=color:#e6db74>`</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>    Remove-Item -Path agent.zip<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># ----- toolchain download start -----</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># see https://github.com/dotnet/dotnet-docker/blob/master/2.2/sdk/nanoserver-1809/amd64/Dockerfile</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>FROM</span><span style=color:#e6db74> mcr.microsoft.com/windows/servercore:ltsc2019 AS toolchain</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>SHELL</span> [<span style=color:#e6db74>&#34;powershell&#34;</span>, <span style=color:#e6db74>&#34;-Command&#34;</span>, <span style=color:#e6db74>&#34;$ErrorActionPreference = &#39;Stop&#39;; $ProgressPreference = &#39;SilentlyContinue&#39;;&#34;</span>]<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># do not bump to 3.0 without changing the next FROM section</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>ENV</span> DOTNET_SDK_VERSION 2.2.105<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>ENV</span> DOTNET_SHA512 d58b0b3f2f82f3960b84e1a7ee36c4febc28db9e08bb99a6dd0b61e5812631d935c471a5ba2f90c966fbcddb208454948339ee5c0d7fbaee4168f3fe6c0827f4<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> Invoke-WebRequest -OutFile dotnet.zip https://dotnetcli.blob.core.windows.net/dotnet/Sdk/$Env:DOTNET_SDK_VERSION/dotnet-sdk-$Env:DOTNET_SDK_VERSION-win-x64.zip; <span style=color:#e6db74>`</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>((</span>Get-FileHash dotnet.zip -Algorithm sha512<span style=color:#f92672>)</span>.Hash -ne $Env:DOTNET_SHA512<span style=color:#f92672>)</span> <span style=color:#f92672>{</span> <span style=color:#e6db74>`</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>        Write-Host <span style=color:#e6db74>&#39;CHECKSUM VERIFICATION FAILED!&#39;</span>; <span style=color:#e6db74>`</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>        exit 1; <span style=color:#e6db74>`</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>    <span style=color:#f92672>}</span>; <span style=color:#e6db74>`</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>    Expand-Archive dotnet.zip -DestinationPath C:<span style=color:#ae81ff>\d</span>otnet; <span style=color:#e6db74>`</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>    Remove-Item -Force dotnet.zip<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># -----  toolchain download end  -----</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>FROM</span><span style=color:#e6db74> mcr.microsoft.com/windows/servercore:ltsc2019</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>SHELL</span> [<span style=color:#e6db74>&#34;powershell&#34;</span>, <span style=color:#e6db74>&#34;-Command&#34;</span>, <span style=color:#e6db74>&#34;$ErrorActionPreference = &#39;Stop&#39;; $ProgressPreference = &#39;SilentlyContinue&#39;;&#34;</span>]<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># ----- toolchain setup start -----</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>COPY</span> --from<span style=color:#f92672>=</span>toolchain <span style=color:#f92672>[</span><span style=color:#e6db74>&#34;C:/dotnet&#34;</span>, <span style=color:#e6db74>&#34;C:/dotnet&#34;</span><span style=color:#f92672>]</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> setx /M PATH <span style=color:#66d9ef>$(</span><span style=color:#e6db74>&#39;C:\dotnet;&#39;</span> + $Env:PATH<span style=color:#66d9ef>)</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># variables to define Capabilities</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>ENV</span> dotnetcore_2.2<span style=color:#f92672>=</span>true<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># -----  toolchain setup end  -----</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># must be passed to run command, we use some bogus values here to highlight what is missing</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>ENV</span> AZP_URL<span style=color:#f92672>=</span>tfs.example.com<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>ENV</span> AZP_TOKEN<span style=color:#f92672>=</span>invalid_PAT
<span style=color:#66d9ef>ENV</span> AZP_POOL<span style=color:#f92672>=</span>Default
<span style=color:#66d9ef>ENV</span> AZP_AGENT_NAME<span style=color:#f92672>=</span>$env:COMPUTERNAME<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>ENV</span> AZP_WORK<span style=color:#f92672>=</span>_work
<span style=color:#75715e># VSO_AGENT_IGNORE contains comma delimited list of vars not to publish as capabilities by Agent</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>ENV</span> VSO_AGENT_IGNORE<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;VSO_AGENT_IGNORE,AZP_AGENT_NAME,AZP_URL,AZP_TOKEN,AZP_POOL&#34;</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>WORKDIR</span><span style=color:#e6db74> C:/BuildAgent</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>COPY</span> --from<span style=color:#f92672>=</span>agent <span style=color:#f92672>[</span><span style=color:#e6db74>&#34;C:/BuildAgent&#34;</span>, <span style=color:#e6db74>&#34;C:/BuildAgent&#34;</span><span style=color:#f92672>]</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>ENTRYPOINT</span> .<span style=color:#ae81ff>\b</span>in<span style=color:#ae81ff>\A</span>gent.Listener.exe configure --unattended <span style=color:#e6db74>`</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>    --agent <span style=color:#e6db74>&#34;</span>$env<span style=color:#e6db74>:AZP_AGENT_NAME&#34;</span> <span style=color:#e6db74>`</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>    --url <span style=color:#e6db74>&#34;</span>$env<span style=color:#e6db74>:AZP_URL&#34;</span> <span style=color:#e6db74>`</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>    --auth PAT <span style=color:#e6db74>`</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>    --token <span style=color:#e6db74>&#34;</span>$env<span style=color:#e6db74>:AZP_TOKEN&#34;</span> <span style=color:#e6db74>`</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>    --pool <span style=color:#e6db74>&#34;</span>$env<span style=color:#e6db74>:AZP_POOL&#34;</span> <span style=color:#e6db74>`</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>    --work <span style=color:#e6db74>&#34;_work&#34;</span> <span style=color:#e6db74>`</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>    --replace; <span style=color:#e6db74>`</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>    .<span style=color:#ae81ff>\b</span>in<span style=color:#ae81ff>\A</span>gent.Listener.exe run<span style=color:#960050;background-color:#1e0010>
</span></code></pre></div><p>There are very few notable things.</p><p>One is the use of environment variables to add Capabilities for Azure Pipelines.
Using <code>setx</code> changes the system PATH before launching the agent; also explicitly put the SDK first in line for commands.
The last trick is to use the <code>VSO_AGENT_IGNORE</code> environment variable: the agent will hide environment variables listed here from build scripts and tasks.</p><p>Note that the Dockerfile states explicitly the versions of Agent and .Net Core SDK to use. This is on purpose: we want fine control over the tool chain used in our builds.</p><p>Checking the hash of downloaded files is a good practice to avoid tampering. SHA 512 is currently recommended over SHA1.
The <code>--replace</code> options permits to re-register the agent with the same name.</p><p>You may wonder why configuring the agent in the ENTRYPOINT clause instead of using a RUN. The reason is to allow instantiating multiple agents from the same image. If we used a RUN, the agent configuration would be hardcoded in the image.</p><h2 id=dockerfile-to-image>Dockerfile to image</h2><p>To validate, we can connect to the Windows VM created in part 1.</p><p>To create the Docker image in the local host cache, that is on the machine where you run the command, execute
<code>docker build -t azure-pipeline-netcore-sdk:2.2 .</code>.
This operation will take a good few minutes, especially if the base image was never pulled in, so it is a good moment to have a cup of tea or coffee.</p><p>The resulting docker image contains the binaries for the Azure Pipelines Agent and the toolchain, in the example .Net Core 2.2.</p><p>Docker build does not run nor registers the agent though. We have to start a container, that is a process, from the image.
Before we would need to collect the same information as if we were registering the agent manually:</p><ul><li>a valid <a href="https://docs.microsoft.com/en-us/azure/devops/organizations/accounts/use-personal-access-tokens-to-authenticate?view=azure-devops" target=_blank rel="noopener noreferrer">Personal Access Token
&nbsp;<i class="fas fa-external-link-alt"></i></a> with <strong>Agent Pools (read, manage)</strong> permission</li><li>the URL of the TFS server or the Azure DevOps Organization</li><li>the name of the Agent Pool</li></ul><p>We can conveniently put this data in an <code>env_file</code>, e.g.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Batchfile data-lang=Batchfile>AZP_URL=https://dev.azure.com/yourorganization
AZP_POOL=Default
AZP_AGENT_NAME=MyFirstAgent
AZP_TOKEN=lrx6554vhogq7lknzznfi4uo75o4hlwfqw6mkr
AZP_WORK=_work
</code></pre></div><p>Now we can start a container named <em>test</em>, executing the command
<code>docker run --env-file .\env_file --rm --name test azure-pipeline-netcore-sdk:2.2</code>,
which should output</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Batchfile data-lang=Batchfile>&gt;&gt; Connect:

Connecting to server ...

&gt;&gt; Register Agent:

Scanning for tool capabilities.
Connecting to the server.
Successfully added the agent
Testing agent connection.
2019-07-06 14:42:46Z: Settings Saved.
Scanning for tool capabilities.
Connecting to the server.
2019-07-06 14:42:55Z: Listening for Jobs
</code></pre></div><p>After a few seconds, the agent will appear in Azure Pipelines.</p><p><figure class=image-caption><a href=/2019/08/30/meta-pipelines-part-2-dockerize-the-agent/new-agent-in-default-pool.png><img loading=lazy height=273 width=713 style=max-width:100%;height:auto srcset="/2019/08/30/meta-pipelines-part-2-dockerize-the-agent/new-agent-in-default-pool_huca8844f6df18174aff6e3db43596b8dd_9313_500x0_resize_box_2.png 500w, /2019/08/30/meta-pipelines-part-2-dockerize-the-agent/new-agent-in-default-pool.png 800w," src=/2019/08/30/meta-pipelines-part-2-dockerize-the-agent/new-agent-in-default-pool.png alt="New Agent in Azure Pipelines Pool"></a><figcaption></figcaption></figure></p><p>By hitting <code>Ctrl+C</code> the console is back, but the container continues to run in the background.
To stop the container run <code>docker stop test</code>; Azure Pipeline will notice this and mark the agent offline.</p><p><figure class=image-caption><a href=/2019/08/30/meta-pipelines-part-2-dockerize-the-agent/offline-agent-in-default-pool.png><img loading=lazy height=273 width=713 style=max-width:100%;height:auto srcset="/2019/08/30/meta-pipelines-part-2-dockerize-the-agent/offline-agent-in-default-pool_hu230877a870cbb4c8fa4e14cef131c766_9334_500x0_resize_box_2.png 500w, /2019/08/30/meta-pipelines-part-2-dockerize-the-agent/offline-agent-in-default-pool.png 800w," src=/2019/08/30/meta-pipelines-part-2-dockerize-the-agent/offline-agent-in-default-pool.png alt="Offline Agent in Azure Pipelines Pool"></a><figcaption></figcaption></figure></p><p>We learned how to create as many Agents as we want on this host but, to properly manage images, we need a Docker Registry to share images between host machines. This will be detailed in the next article.</p><h2 id=dockerfile-for-a-linux-azure-pipelines-agent>Dockerfile for a Linux Azure Pipelines agent</h2><p>After successfully being able to run an Azure Pipelines agent on Windows, let&rsquo;s do the same on Linux.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Dockerfile data-lang=Dockerfile><span style=color:#66d9ef>FROM</span><span style=color:#e6db74> alpine AS agent</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>ENV</span> AGENT_VERSION 2.153.2<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>ENV</span> AGENT_SHA256 59566e23ee745f47a8391b59f9e3de596abb5cdf425dbcd2aba155e43b6f0ab9<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>WORKDIR</span><span style=color:#e6db74> /agent</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> apk add --no-cache curl<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> curl -o vsts-agent-linux-x64.tgz https://vstsagentpackage.azureedge.net/agent/<span style=color:#e6db74>${</span>AGENT_VERSION<span style=color:#e6db74>}</span>/vsts-agent-linux-x64-<span style=color:#e6db74>${</span>AGENT_VERSION<span style=color:#e6db74>}</span>.tar.gz <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>    <span style=color:#f92672>&amp;&amp;</span> echo <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>${</span>AGENT_SHA256<span style=color:#e6db74>}</span><span style=color:#e6db74> *vsts-agent-linux-x64.tgz&#34;</span> | sha256sum -c - <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>    <span style=color:#f92672>&amp;&amp;</span> tar zxvf vsts-agent-linux-x64.tgz <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>    <span style=color:#f92672>&amp;&amp;</span> rm vsts-agent-linux-x64.tgz<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># ----- toolchain start -----</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>FROM</span><span style=color:#e6db74> node:12.6.0</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># ----- toolchain end -----</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># Azure Pipelines agent require git 2.9 or later</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> apt-get install git -y<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>COPY</span> --from<span style=color:#f92672>=</span>agent <span style=color:#f92672>[</span><span style=color:#e6db74>&#34;/agent&#34;</span>, <span style=color:#e6db74>&#34;/agent&#34;</span><span style=color:#f92672>]</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>USER</span><span style=color:#e6db74> root</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>WORKDIR</span><span style=color:#e6db74> /agent</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>COPY</span> ./start.sh .<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> chmod +x start.sh<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>ENTRYPOINT</span> [<span style=color:#e6db74>&#34;/bin/bash&#34;</span>, <span style=color:#e6db74>&#34;-c&#34;</span>,<span style=color:#e6db74>&#34;/agent/start.sh&#34;</span>]<span style=color:#960050;background-color:#1e0010>
</span></code></pre></div><p>This Dockerfile is different because we are fine with an existing Docker image and just need to add the Linux agent to it.</p><p>More notable is the <code>start.sh</code> script</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#75715e>#!/bin/bash
</span><span style=color:#75715e></span>set -e

<span style=color:#66d9ef>if</span> <span style=color:#f92672>[</span> -z <span style=color:#e6db74>&#34;</span>$AZP_URL<span style=color:#e6db74>&#34;</span> <span style=color:#f92672>]</span>; <span style=color:#66d9ef>then</span>
  echo 1&gt;&amp;<span style=color:#ae81ff>2</span> error: missing AZP_URL environment variable
  exit <span style=color:#ae81ff>1</span>
<span style=color:#66d9ef>fi</span>

<span style=color:#66d9ef>if</span> <span style=color:#f92672>[</span> -z <span style=color:#e6db74>&#34;</span>$AZP_TOKEN_FILE<span style=color:#e6db74>&#34;</span> <span style=color:#f92672>]</span>; <span style=color:#66d9ef>then</span>
  <span style=color:#66d9ef>if</span> <span style=color:#f92672>[</span> -z <span style=color:#e6db74>&#34;</span>$AZP_TOKEN<span style=color:#e6db74>&#34;</span> <span style=color:#f92672>]</span>; <span style=color:#66d9ef>then</span>
    echo 1&gt;&amp;<span style=color:#ae81ff>2</span> error: missing AZP_TOKEN environment variable
    exit <span style=color:#ae81ff>1</span>
  <span style=color:#66d9ef>fi</span>
  AZP_TOKEN_FILE<span style=color:#f92672>=</span>/agent/.token
  echo -n $AZP_TOKEN &gt; <span style=color:#e6db74>&#34;</span>$AZP_TOKEN_FILE<span style=color:#e6db74>&#34;</span>
<span style=color:#66d9ef>fi</span>
unset AZP_TOKEN

<span style=color:#66d9ef>if</span> <span style=color:#f92672>[</span> -n <span style=color:#e6db74>&#34;</span>$AZP_AGENT_NAME<span style=color:#e6db74>&#34;</span> <span style=color:#f92672>]</span>; <span style=color:#66d9ef>then</span>
  export AZP_AGENT_NAME<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;</span><span style=color:#66d9ef>$(</span>eval echo $AZP_AGENT_NAME<span style=color:#66d9ef>)</span><span style=color:#e6db74>&#34;</span>
<span style=color:#66d9ef>fi</span>

<span style=color:#66d9ef>if</span> <span style=color:#f92672>[</span> -n <span style=color:#e6db74>&#34;</span>$AZP_WORK<span style=color:#e6db74>&#34;</span> <span style=color:#f92672>]</span>; <span style=color:#66d9ef>then</span>
  export AZP_WORK<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;</span><span style=color:#66d9ef>$(</span>eval echo $AZP_WORK<span style=color:#66d9ef>)</span><span style=color:#e6db74>&#34;</span>
  mkdir -p <span style=color:#e6db74>&#34;</span>$AZP_WORK<span style=color:#e6db74>&#34;</span>
<span style=color:#66d9ef>fi</span>

cd /agent

export VSO_AGENT_IGNORE<span style=color:#f92672>=</span>_,MAIL,OLDPWD,PATH,PWD,AZP_AGENT_NAME,AZP_URL,AZP_TOKEN_FILE,AZP_TOKEN,AZP_POOL,AZP_WORK,VSO_AGENT_IGNORE
<span style=color:#66d9ef>if</span> <span style=color:#f92672>[</span> -n <span style=color:#e6db74>&#34;</span>$VSTS_AGENT_IGNORE<span style=color:#e6db74>&#34;</span> <span style=color:#f92672>]</span>; <span style=color:#66d9ef>then</span>
  export VSO_AGENT_IGNORE<span style=color:#f92672>=</span>$VSO_AGENT_IGNORE,VSTS_AGENT_IGNORE,$VSTS_AGENT_IGNORE
<span style=color:#66d9ef>fi</span>

source ./env.sh

./bin/Agent.Listener configure --unattended <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>  --agent <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>${</span>AZP_AGENT_NAME<span style=color:#66d9ef>:-$(</span>hostname<span style=color:#66d9ef>)</span><span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span> <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>  --url <span style=color:#e6db74>&#34;</span>$AZP_URL<span style=color:#e6db74>&#34;</span> <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>  --auth PAT <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>  --token <span style=color:#66d9ef>$(</span>cat <span style=color:#e6db74>&#34;</span>$AZP_TOKEN_FILE<span style=color:#e6db74>&#34;</span><span style=color:#66d9ef>)</span> <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>  --pool <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>${</span>AZP_POOL<span style=color:#66d9ef>:-</span>Default<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span> <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>  --work <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>${</span>AZP_WORK<span style=color:#66d9ef>:-</span>_work<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span> <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>  --replace &amp; wait $!

./bin/Agent.Listener run &amp; wait $!
</code></pre></div><p>With these two files, we build the image executing <code>docker build -t azure-pipeline-node:12.6.0 .</code>.</p><p>To test, we run <code>docker run --env-file ./env_file --rm --name test azure-pipeline-node:12.6.0</code> after editing the <code>env_file</code>, e.g.</p><pre><code class=language-Bathcfile data-lang=Bathcfile>AZP_URL=https://dev.azure.com/yourorganization
AZP_POOL=Default
AZP_AGENT_NAME=MySecondAgent
AZP_TOKEN=lrx6554vhogq7lknzznfi4uo75o4hlwfqw6mkr
AZP_WORK=_work
</code></pre><p>Note the different value for the agent name: it must be so or it will take the place of the Windows agent!</p><p>Now we have two agents registered.</p><p><figure class=image-caption><a href=/2019/08/30/meta-pipelines-part-2-dockerize-the-agent/two-agents.png><img loading=lazy height=326 width=706 style=max-width:100%;height:auto srcset="/2019/08/30/meta-pipelines-part-2-dockerize-the-agent/two-agents_hu16f5abad7ad2180082a4a358322dffac_11706_500x0_resize_box_2.png 500w, /2019/08/30/meta-pipelines-part-2-dockerize-the-agent/two-agents.png 800w," src=/2019/08/30/meta-pipelines-part-2-dockerize-the-agent/two-agents.png alt="Two agents"></a><figcaption></figcaption></figure></p><h2 id=azure-devops-server-and-agent-upgrades>Azure DevOps Server and agent upgrades</h2><p>The code above works perfectly fine when you have full control of upgrades, that is an on-premise Team Foundation Server or Azure DevOps Server.</p><p>Azure DevOps Service may upgrade without you noticing and there is a domino effect. The documentation states indeed in from <a href="https://docs.microsoft.com/en-us/azure/devops/pipelines/agents/agents?view=azure-devops#how-do-i-make-sure-i-have-the-latest-v2-agent-version" target=_blank rel="noopener noreferrer">Q & A
&nbsp;<i class="fas fa-external-link-alt"></i></a> section that:</p><blockquote><p>Each agent automatically updates itself when it runs a task that requires a newer version of the agent.</p></blockquote><p>This means that the agent may self-upgrade on occasion&mldr; and break the container!</p><p>What is the solution? It is described in <a href=https://docs.microsoft.com/en-us/azure/devops/pipelines/agents/docker target=_blank rel="noopener noreferrer">Running a self-hosted agent in Docker
&nbsp;<i class="fas fa-external-link-alt"></i>
</a>: the idea is to download, configure and start the agent in a single action using a bootstrap script. I will not copy here the <code>start.ps1</code> and <code>start.sh</code> file; I will simply illustrate how to adapt the above Dockerfiles in this scenario.</p><blockquote><p>This approach will not function in air-gapped environments: the container requires internet access in addition to TFS/Azure DevOps Server.</p></blockquote><h3 id=azure-pipelines-service-windows-dockerfile>Azure Pipelines Service Windows Dockerfile</h3><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Dockerfile data-lang=Dockerfile><span style=color:#75715e># escape=`</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># ----- toolchain download start -----</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># see https://github.com/dotnet/dotnet-docker/blob/master/2.2/sdk/nanoserver-1809/amd64/Dockerfile</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>FROM</span><span style=color:#e6db74> mcr.microsoft.com/windows/servercore:ltsc2019 AS toolchain</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>SHELL</span> [<span style=color:#e6db74>&#34;powershell&#34;</span>, <span style=color:#e6db74>&#34;-Command&#34;</span>, <span style=color:#e6db74>&#34;$ErrorActionPreference = &#39;Stop&#39;; $ProgressPreference = &#39;SilentlyContinue&#39;;&#34;</span>]<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># do not bump to 3.0 without changing the next FROM section</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>ENV</span> DOTNET_SDK_VERSION 2.2.105<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>ENV</span> DOTNET_SHA512 d58b0b3f2f82f3960b84e1a7ee36c4febc28db9e08bb99a6dd0b61e5812631d935c471a5ba2f90c966fbcddb208454948339ee5c0d7fbaee4168f3fe6c0827f4<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> Invoke-WebRequest -OutFile dotnet.zip https://dotnetcli.blob.core.windows.net/dotnet/Sdk/$Env:DOTNET_SDK_VERSION/dotnet-sdk-$Env:DOTNET_SDK_VERSION-win-x64.zip; <span style=color:#e6db74>`</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>((</span>Get-FileHash dotnet.zip -Algorithm sha512<span style=color:#f92672>)</span>.Hash -ne $Env:DOTNET_SHA512<span style=color:#f92672>)</span> <span style=color:#f92672>{</span> <span style=color:#e6db74>`</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>        Write-Host <span style=color:#e6db74>&#39;CHECKSUM VERIFICATION FAILED!&#39;</span>; <span style=color:#e6db74>`</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>        exit 1; <span style=color:#e6db74>`</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>    <span style=color:#f92672>}</span>; <span style=color:#e6db74>`</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>    Expand-Archive dotnet.zip -DestinationPath C:<span style=color:#ae81ff>\d</span>otnet; <span style=color:#e6db74>`</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>    Remove-Item -Force dotnet.zip<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># -----  toolchain download end  -----</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>FROM</span><span style=color:#e6db74> mcr.microsoft.com/windows/servercore:ltsc2019</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>SHELL</span> [<span style=color:#e6db74>&#34;powershell&#34;</span>, <span style=color:#e6db74>&#34;-Command&#34;</span>, <span style=color:#e6db74>&#34;$ErrorActionPreference = &#39;Stop&#39;; $ProgressPreference = &#39;SilentlyContinue&#39;;&#34;</span>]<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># ----- toolchain setup start -----</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>COPY</span> --from<span style=color:#f92672>=</span>toolchain <span style=color:#f92672>[</span><span style=color:#e6db74>&#34;C:/dotnet&#34;</span>, <span style=color:#e6db74>&#34;C:/dotnet&#34;</span><span style=color:#f92672>]</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> setx /M PATH <span style=color:#66d9ef>$(</span><span style=color:#e6db74>&#39;C:\dotnet;&#39;</span> + $Env:PATH<span style=color:#66d9ef>)</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># variables to define Capabilities</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>ENV</span> dotnetcore_2.2<span style=color:#f92672>=</span>true<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># -----  toolchain setup end  -----</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># must be passed to run command, we use some bogus values here to highlight what is missing</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>ENV</span> AZP_URL<span style=color:#f92672>=</span>tfs.example.com<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>ENV</span> AZP_TOKEN<span style=color:#f92672>=</span>invalid_PAT
<span style=color:#66d9ef>ENV</span> AZP_POOL<span style=color:#f92672>=</span>Default
<span style=color:#66d9ef>ENV</span> AZP_AGENT_NAME<span style=color:#f92672>=</span>$env:COMPUTERNAME<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>ENV</span> AZP_WORK<span style=color:#f92672>=</span>_work

<span style=color:#66d9ef>WORKDIR</span><span style=color:#e6db74> C:/BuildAgent</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>COPY</span> start.ps1 .<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>CMD</span> powershell .<span style=color:#ae81ff>\s</span>tart.ps1<span style=color:#960050;background-color:#1e0010>
</span></code></pre></div><p>This image will be about 300 MB smaller without the agent image but the container will take many minutes to start, fail if it cannot connect to the Internet and use 100 MB more.</p><h3 id=azure-pipelines-service-linux-dockerfile>Azure Pipelines Service Linux Dockerfile</h3><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Dockerfile data-lang=Dockerfile><span style=color:#66d9ef>FROM</span><span style=color:#e6db74> node:12.6.0</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># Azure Pipelines agent require git 2.9 or later</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> apt-get install git -y<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>USER</span><span style=color:#e6db74> root</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>WORKDIR</span><span style=color:#e6db74> /agent</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>COPY</span> ./start.sh .<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> chmod +x start.sh<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>CMD</span> [<span style=color:#e6db74>&#34;./start.sh&#34;</span>]<span style=color:#960050;background-color:#1e0010>
</span></code></pre></div><p>The considerations are similar to Windows: a leaner image but slower to start container which requires Internet access.</p><h2 id=caching-incremental-builds-and-working-directory>Caching, incremental builds and working directory</h2><p>In all examples above we have not specified a working directory for the agent. This is the recommended approach unless you have special requirements.</p><p>In the default scenario, the working directory is within the container image; if the container is restarted the content is lost. This can have an unpleasant effect on caching and break incremental builds that assume they are working on the same filesystem.</p><p>You may use an external volume, even living on a network share, for the agent working directory, if you specify these three things:</p><ol><li>in the Dockerfile modify <code>ENV AZP_WORK=/agent_work</code> and add <code>VOLUME /agent_work</code></li><li>create a volume for the container <code>docker volume create agent1-work</code></li><li>start the container specifying the volume <code>docker run --mount source=agent1-work,target=/agent_work --env-file .\env_file --rm --name test azure-pipeline-netcore-sdk:2.2</code></li></ol><p>Docker volumes is a complex topic and I recommend to study the documentation at <a href=https://docs.docker.com/storage/volumes target=_blank rel="noopener noreferrer">Use volumes
&nbsp;<i class="fas fa-external-link-alt"></i>
</a>.</p><h2 id=limits-of-docker-approach>Limits of Docker approach</h2><p>The container process has no Windows Identity for the host machine, so it cannot access Windows networks like SMB shares. As a consequence you cannot use UNC <em>file share</em> for <strong>Artifact publish location</strong> in the Publish Artifacts Task.
Another issue is the Agent not being deleted when we stop the container.</p><p>And this is enough for a post, see you in the next instalment.</p></p></div><div class=card-footer><small class=text-muted><i class="fas fa-folder text-primary"></i>&nbsp;
<a href=/categories/#devops class="badge badge-primary"><span>DevOps</span></a><br><i class="fas fa-tags text-secondary"></i>&nbsp;
<a href=/tags/#build class="badge badge-secondary"><span>Build</span></a>
<a href=/tags/#pipelines class="badge badge-secondary"><span>Pipelines</span></a>
<a href=/tags/#azure-devops class="badge badge-secondary"><span>Azure DevOps</span></a>
<a href=/tags/#docker class="badge badge-secondary"><span>Docker</span></a></small></div></div></div></main><footer class="navbar-light border-top"><div class=container><div class=row><div class="col-12 col-md-3 mb-3"><h5>Giulio Vian's Blog!</h5>Notes and considerations of small venetian guy on DevOps tools, architecture, development and other paraphernalia.</div><div class="col-12 col-md-3 mb-3"><h5>Social</h5><ul class="list-unstyled list-inline"><li class=list-inline-item><a href=https://github.com/giuliov target=_blank rel="noopener noreferrer" title=GitHub class="fab fa-github fa-2x"></a></li><li class=list-inline-item><a href=https://stackoverflow.com/users/100864 target=_blank rel="noopener noreferrer" title="Stack Overflow" class="fab fa-stack-overflow fa-2x"></a></li><li class=list-inline-item><a href=https://medium.com/@giuliovdev target=_blank rel="noopener noreferrer" title=Medium class="fab fa-medium fa-2x"></a></li><li class=list-inline-item><a href=https://linkedin.com/in/giuliovian target=_blank rel="noopener noreferrer" title=LinkedIn class="fab fa-linkedin fa-2x"></a></li><li class=list-inline-item><a href=https://linkedin.com/company/unum-ireland-ltd-it target=_blank rel="noopener noreferrer" title="LinkedIn Company" class="fab fa-linkedin fa-2x"></a></li><li class=list-inline-item><a href=https://xing.com/profile/Giulio_Vian target=_blank rel="noopener noreferrer" title=Xing class="fab fa-xing fa-2x"></a></li><li class=list-inline-item><a href=https://slideshare.net/giuliov target=_blank rel="noopener noreferrer" title=SlideShare class="fab fa-slideshare fa-2x"></a></li><li class=list-inline-item><a href=https://youtube.com/UCZ-J6JRyvz6aaJ9zCN5wpxA target=_blank rel="noopener noreferrer" title=YouTube class="fab fa-youtube fa-2x"></a></li><li class=list-inline-item><a href=https://twitter.com/giulio_vian target=_blank rel="noopener noreferrer" title=Twitter class="fab fa-twitter fa-2x"></a></li><li class=list-inline-item><a href=mailto:giulio.dev@casavian.eu title=Email class="fas fa-envelope fa-2x"></a></li></ul></div><div class="col-12 col-md-3 mb-3"><h5>Site</h5><ul class=list-unstyled><li><a href=/about/><i class="fas fa-address-card"></i>About</a></li><li><a href=/categories/><i class="fas fa-folder"></i>Categories</a></li><li><a href=/series/><i class="fas fa-book"></i>Series</a></li><li><a href=/tags/><i class="fas fa-tags"></i>Tags</a></li></ul></div><div class="col-12 col-md-3 mb-3">&copy; 2020 Giulio Vian<br>Theme by <a href=https://www.spech.de target=_blank rel="noopener noreferrer">Sebastian Pech</a>.</div></div></div></footer><script src=/js/vendor.min.0497fa926ed3dc2241b91e016467480841da9749a0f7c40ed3960c3c238745e5accb5ec5e07654668e11047bbf96f95083b88dd49a845781011aba42e4f00a5d.js integrity="sha512-BJf6km7T3CJBuR4BZGdICEHal0mg98QO05YMPCOHReWsy17F4HZUZo4RBHu/lvlQg7iN1JqEV4EBGrpC5PAKXQ=="></script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-46796059-1','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script></body></html>