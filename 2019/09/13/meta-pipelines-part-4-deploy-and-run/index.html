<!doctype html><html lang=en><meta charset=utf-8><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"http:\/\/blog.casavian.eu\/"},"articleSection":"post","name":"Meta-pipelines - Part 4 - Deploy and Run","headline":"Meta-pipelines - Part 4 - Deploy and Run","description":"Notes and considerations of small venetian guy on DevOps tools, architecture, development and other paraphernalia.","inLanguage":"en","author":"Giulio Vian","creator":"Giulio Vian","publisher":"Giulio Vian","accountablePerson":"Giulio Vian","copyrightHolder":"Giulio Vian","copyrightYear":"2019","datePublished":"2019-09-13T00:00:00Z","dateModified":"2019-09-13T00:00:00Z","url":"\/2019\/09\/13\/meta-pipelines-part-4-deploy-and-run\/","wordCount":"980","keywords":["Build","Pipelines","Azure DevOps","Docker","Blog"]}</script><title>Meta-pipelines - Part 4 - Deploy and Run &ndash; Giulio Vian's Blog!</title><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=description content="Notes and considerations of small venetian guy on DevOps tools, architecture, development and other paraphernalia."><meta name=author content="Giulio Vian"><link rel=icon href=/favicon.ico><meta itemprop=name content="Meta-pipelines - Part 4 - Deploy and Run"><meta itemprop=description content="In the previous instalment we built custom Docker images for Azure Pipelines/TFS Agents. In this post, we will explore the lifecycle of Docker containers running such images.
Container Deploy Pipeline This pipeline is more complex than the previous requiring 4 actions:
 checking if the agent (rectius the container running the agent) is running If so, stop and remove the container Pulling the image from the selected Docker Registry Starting the container with the proper parameters."><meta itemprop=datePublished content="2019-09-13T00:00:00+00:00"><meta itemprop=dateModified content="2019-09-13T00:00:00+00:00"><meta itemprop=wordCount content="980"><meta itemprop=image content="http://blog.casavian.eu/2019/09/13/meta-pipelines-part-4-deploy-and-run/feature-banner.jpg"><meta itemprop=keywords content="Build,Pipelines,Azure DevOps,Docker,"><meta property="og:title" content="Meta-pipelines - Part 4 - Deploy and Run"><meta property="og:description" content="In the previous instalment we built custom Docker images for Azure Pipelines/TFS Agents. In this post, we will explore the lifecycle of Docker containers running such images.
Container Deploy Pipeline This pipeline is more complex than the previous requiring 4 actions:
 checking if the agent (rectius the container running the agent) is running If so, stop and remove the container Pulling the image from the selected Docker Registry Starting the container with the proper parameters."><meta property="og:type" content="article"><meta property="og:url" content="http://blog.casavian.eu/2019/09/13/meta-pipelines-part-4-deploy-and-run/"><meta property="og:image" content="http://blog.casavian.eu/2019/09/13/meta-pipelines-part-4-deploy-and-run/feature-banner.jpg"><meta property="article:published_time" content="2019-09-13T00:00:00+00:00"><meta property="article:modified_time" content="2019-09-13T00:00:00+00:00"><meta property="og:site_name" content="Giulio Vian's Blog!"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="http://blog.casavian.eu/2019/09/13/meta-pipelines-part-4-deploy-and-run/feature-banner.jpg"><meta name=twitter:title content="Meta-pipelines - Part 4 - Deploy and Run"><meta name=twitter:description content="In the previous instalment we built custom Docker images for Azure Pipelines/TFS Agents. In this post, we will explore the lifecycle of Docker containers running such images.
Container Deploy Pipeline This pipeline is more complex than the previous requiring 4 actions:
 checking if the agent (rectius the container running the agent) is running If so, stop and remove the container Pulling the image from the selected Docker Registry Starting the container with the proper parameters."><meta name=twitter:site content="@giulio_vian"><link rel=alternate href=/index.xml type=application/rss+xml title="Giulio Vian's Blog!"><link rel=stylesheet href=/css/vendor.min.95b0b4c4607aec507f0fc9d9c36a12a4613ccac06f9423caa43e265cb58eb5f90709388cc0fa166ac3ca836b4163e6d0569b8b86065d9cabdf223c5ea9a63b08.css integrity="sha512-lbC0xGB67FB/D8nZw2oSpGE8ysBvlCPKpD4mXLWOtfkHCTiMwPoWasPKg2tBY+bQVpuLhgZdnKvfIjxeqaY7CA=="><link href=http://blog.casavian.eu/css/cookieconsent.min.cd0d0b6e50ff01ff2f3a9a70d7cfb66a7c6cb9acf7a566325568be6d3bd31fc4.css rel=stylesheet type=text/css integrity="sha256-zQ0LblD/Af8vOppw18+2anxsuaz3pWYyVWi+bTvTH8Q=" crossorigin=anonymous><script src=http://blog.casavian.eu/js/cookieconsent.min.e55842a856a6d829feca3c3ad736c136b6c7549e9247274f78aa296259e06e24.js integrity="sha256-5VhCqFam2Cn+yjw61zbBNrbHVJ6SRydPeKopYlngbiQ=" crossorigin=anonymous async></script><script>window.addEventListener("load",function(){window.cookieconsent.initialise({"palette":{"popup":{"background":"#428bca","text":"#ffffff"},"button":{"background":"#f71559"}},"content":{"message":'This website uses cookies.',"dismiss":'Got it!',"link":'Learn more.',"href":"http:\/\/blog.casavian.eu\/page\/privacy-cookies-policy\/"},"position":"bottom-right"})});</script><body><nav class="navbar navbar-light bg-white navbar-expand-lg border-bottom"><div class=container><a class="navbar-brand text-primary" href=/>Giulio Vian's Blog!</a>
<button class="navbar-toggler collapsed" type=button data-toggle=collapse data-target=#navbarCollapse aria-controls=navbarCollapse aria-expanded=false aria-label="Toggle navigation">
<span class=navbar-toggler-icon></span></button><div class="navbar-collapse collapse" id=navbarCollapse><ul class="navbar-nav mr-auto"><li class=nav-item><a class="nav-link text-primary" href=/index.html><i class="fas fa-home"></i>Home</a></li><li class=nav-item><a class="nav-link text-primary" href=/page/about/><i class="fa fa-info-circle"></i>About</a></li><li class=nav-item><a class="nav-link text-primary" href=/page/public-speaking><i class="fa fa-microphone"></i>Speaking</a></li></ul></div></div></nav><main role=main><div class="container mt-3 mb-3"><div class=card><img class=card-img-top src=/2019/09/13/meta-pipelines-part-4-deploy-and-run/feature-banner_hu34c3e573966966cb30c13e11fba0381d_392742_1108x0_resize_q75_box.jpg alt="Meta-pipelines - Part 4 - Deploy and Run" title="Meta-pipelines - Part 4 - Deploy and Run"><div class=card-body><h1 class=card-title><a href=/2019/09/13/meta-pipelines-part-4-deploy-and-run/>Meta-pipelines - Part 4 - Deploy and Run</a></h1><h6 class="card-subtitle mb-2 text-muted"><i class="fas fa-calendar-day"></i>&nbsp;13 Sep 2019 -
<i class="fas fa-user"></i>&nbsp;Giulio Vian
- <i class="fas fa-clock"></i>&nbsp;~5 Minutes</h6><p class=card-text><p>In the previous instalment we built custom Docker images for Azure Pipelines/TFS Agents. In this post, we will explore the lifecycle of Docker containers running such images.</p><h2 id=container-deploy-pipeline>Container Deploy Pipeline</h2><p>This pipeline is more complex than the previous requiring 4 actions:</p><ol><li>checking if the agent (<em>rectius</em> the container running the agent) is running</li><li>If so, stop and remove the container</li><li>Pulling the image from the selected Docker Registry</li><li>Starting the container with the proper parameters.</li></ol><p>While logically at third place, the pull operation does not interfere with running containers. This means that we can minimize downtime by making the stop-start sequence contiguous.</p><p>Again, we use a generic template plus a YAML build that uses it.
The template has six steps, fleshing out the four actions.</p><p>The parameters should be obvious except the distinction between <code>docker_registry</code> and <code>docker_registry_connection</code>. The former is the hostname of the Docker Registry, the latter is the name for the connection in Azure DevOps.</p><p><figure class=image-caption><a href=/2019/09/13/meta-pipelines-part-4-deploy-and-run/azdo-serviceconnection-to-ACR.png><img loading=lazy height=401 width=671 style=max-width:100%;height:auto srcset="/2019/09/13/meta-pipelines-part-4-deploy-and-run/azdo-serviceconnection-to-ACR_hue2c03ddafc69023cb4ce3e890d53399f_42242_500x0_resize_box_2.png 500w, /2019/09/13/meta-pipelines-part-4-deploy-and-run/azdo-serviceconnection-to-ACR.png 800w," src=/2019/09/13/meta-pipelines-part-4-deploy-and-run/azdo-serviceconnection-to-ACR.png alt="Service connection to Docker Registry in Azure DevOps"></a><figcaption></figcaption></figure></p><p>Hostname is part of the image name, while the connection name is used in the Docker login step.
I recommend naming the connection the same as the Hostname.
Another interesting couple of parameters is <code>os</code> vs <code>os_tag</code>: the former is the conventional name for the Host OS and Container platform, while the latter is the Agent Capability <code>Agent.OS</code>.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#66d9ef>parameters</span>:
  <span style=color:#66d9ef>os</span>: <span style=color:#e6db74>&#39;&#39;</span>
  <span style=color:#66d9ef>os_tag</span>: <span style=color:#e6db74>&#39;&#39;</span>
  <span style=color:#66d9ef>toolchain</span>: <span style=color:#e6db74>&#39;&#39;</span>
  <span style=color:#66d9ef>toolchain_version</span>: <span style=color:#e6db74>&#39;&#39;</span>
  <span style=color:#66d9ef>container_name_suffix</span>: <span style=color:#e6db74>&#39;&#39;</span>
  <span style=color:#66d9ef>repo_docker_path</span>: <span style=color:#e6db74>&#39;src/agents/docker&#39;</span>
  <span style=color:#66d9ef>image_name_prefix</span>: <span style=color:#e6db74>&#39;azure-pipelines-agent&#39;</span>
  <span style=color:#66d9ef>docker_registry</span>: <span style=color:#e6db74>&#39; mydemo.azurecr.io&#39;</span>
  <span style=color:#66d9ef>docker_registry_connection</span>: <span style=color:#e6db74>&#39;mydemo.azurecr.io&#39;</span>

<span style=color:#66d9ef>jobs</span>:
- <span style=color:#66d9ef>job</span>: <span style=color:#e6db74>&#39;deploy_${{ parameters.os }}&#39;</span>
  <span style=color:#66d9ef>pool</span>:
    <span style=color:#66d9ef>name</span>: MakeAgents
    <span style=color:#66d9ef>demands</span>:
    - <span style=color:#e6db74>&#39;agent.os -equals ${{ coalesce( parameters.os_tag, parameters.os ) }}&#39;</span>
  <span style=color:#66d9ef>variables</span>:
    <span style=color:#66d9ef>docker_image_id</span>: <span style=color:#e6db74>&#39;${{ parameters.docker_registry }}/${{ parameters.image_name_prefix }}/${{ parameters.os }}/${{ parameters.toolchain }}:${{ parameters.toolchain_version }}&#39;</span>
    <span style=color:#66d9ef>container_name</span>: <span style=color:#e6db74>&#39;${{ parameters.toolchain }}-${{ parameters.toolchain_version }}${{ parameters.container_name_suffix }}&#39;</span>
  <span style=color:#66d9ef>steps</span>:
  - <span style=color:#66d9ef>powershell</span>: <span style=color:#e6db74>|
</span><span style=color:#e6db74>      echo Must define AZURE_DEVOPS_PAT variable!</span>
      exit <span style=color:#ae81ff>1</span>
    <span style=color:#66d9ef>condition</span>: eq(variables[<span style=color:#e6db74>&#39;AZURE_DEVOPS_PAT&#39;</span>], <span style=color:#e6db74>&#39;&#39;</span>)
    <span style=color:#66d9ef>env</span>:
      <span style=color:#66d9ef>AZURE_DEVOPS_PAT</span>: <span style=color:#e6db74>&#39;$(AZURE_DEVOPS_PAT)&#39;</span>
  - <span style=color:#66d9ef>task</span>: Docker@<span style=color:#ae81ff>2</span>
    <span style=color:#66d9ef>displayName</span>: Login to Docker Registry
    <span style=color:#66d9ef>inputs</span>:
      <span style=color:#66d9ef>command</span>: login
      <span style=color:#66d9ef>containerRegistry</span>: <span style=color:#e6db74>&#39;${{ parameters.docker_registry_connection }}&#39;</span>
  - <span style=color:#66d9ef>task</span>: Docker@<span style=color:#ae81ff>2</span>
    <span style=color:#66d9ef>displayName</span>: <span style=color:#e6db74>&#39;Pull $(docker_image_id)&#39;</span>
    <span style=color:#66d9ef>inputs</span>:
      <span style=color:#66d9ef>command</span>: pull
      <span style=color:#66d9ef>arguments</span>: <span style=color:#e6db74>&#39;$(docker_image_id)&#39;</span>
  - <span style=color:#66d9ef>powershell</span>: <span style=color:#e6db74>|
</span><span style=color:#e6db74>      $ContainerName = &#34;$(container_name)&#34;</span>
      $res = docker ps --format <span style=color:#e6db74>&#34;{{.ID}}&#34;</span> --filter <span style=color:#e6db74>&#34;name=$ContainerName&#34;</span>
      $value = if ($res -eq $<span style=color:#66d9ef>null</span>) { <span style=color:#e6db74>&#34;false&#34;</span> } else { <span style=color:#e6db74>&#34;true&#34;</span> }
      Write-Host <span style=color:#e6db74>&#34;ContainerIsRunning=$value&#34;</span>
      Write-Output <span style=color:#e6db74>&#34;##vso[task.setvariable variable=ContainerIsRunning;]$value&#34;</span>
    <span style=color:#66d9ef>displayName</span>: <span style=color:#e6db74>&#39;Check if container $(container_name) is running&#39;</span>
  - <span style=color:#66d9ef>task</span>: Docker@<span style=color:#ae81ff>2</span>
    <span style=color:#66d9ef>displayName</span>: <span style=color:#e6db74>&#39;Stop running container $(container_name)&#39;</span>
    <span style=color:#66d9ef>inputs</span>:
      <span style=color:#66d9ef>command</span>: rm
      <span style=color:#66d9ef>arguments</span>: <span style=color:#e6db74>&#39;--force $(container_name)&#39;</span>
    <span style=color:#66d9ef>condition</span>: and(succeeded(), eq(variables[<span style=color:#e6db74>&#39;ContainerIsRunning&#39;</span>], <span style=color:#e6db74>&#39;true&#39;</span>))
  - <span style=color:#66d9ef>task</span>: Docker@<span style=color:#ae81ff>2</span>
    <span style=color:#66d9ef>displayName</span>: <span style=color:#e6db74>&#39;Run container $(container_name)&#39;</span>
    <span style=color:#66d9ef>inputs</span>:
      <span style=color:#66d9ef>command</span>: run
      <span style=color:#66d9ef>arguments</span>: <span style=color:#e6db74>&#39;--name=$(container_name) --restart=always --env AZP_URL --env AZP_TOKEN --env AZP_POOL --env AZP_AGENT_NAME --detach $(docker_image_id)&#39;</span>
    <span style=color:#66d9ef>env</span>:
      <span style=color:#66d9ef>AZP_URL</span>: <span style=color:#e6db74>&#39;$(System.TeamFoundationCollectionUri)&#39;</span>
      <span style=color:#66d9ef>AZP_TOKEN</span>: <span style=color:#e6db74>&#39;$(AZURE_DEVOPS_PAT)&#39;</span>
      <span style=color:#66d9ef>AZP_POOL</span>: <span style=color:#e6db74>&#39;Default&#39;</span>
      <span style=color:#66d9ef>AZP_AGENT_NAME</span>: <span style=color:#e6db74>&#39;$(container_name)&#39;</span>
</code></pre></div><p>The template requires the <em>MakeAgents</em> Pool and specific Container platform for the image.
After checking if the <code>AZURE_DEVOPS_PAT</code> is set (the YAML Template has no provision to require a mandatory global variable), the template pulls the image from the Registry; this can be the most expensive operation.
To check if a container with the same name is running on the host, the PowerShell script parses the output of <code>docker ps</code> and sets the <code>ContainerIsRunning</code> variable.
This variable is used to conditionally execute <code>docker rm --force</code> to forcibly stop the container.
With a clean state, the template can finally start the container.</p><h3 id=run-the-container>Run the container</h3><p>The first notable thing is the <code>--restart=always</code> to tell Docker to restart the container in all case, included a host machine reboot. This gives a degree of resilience in case of crashes but can hide issues: if the container has a configuration error, Docker will insist restarting the container. This scenario becomes visible in Azure Pipelines, a minute or two after the pipeline completes successfully: the agent stays offline, when replacing an existing agent, or never shows up.
In such case, connect to the host server, via RDP or SSH, and run <code>docker logs &lt;container-name></code> to see the error output.</p><p>The <code>--detach</code> option to start the container process asynchronously and freeing the host agent to complete the build. As a consequence, the container may starts successfully but fails after some seconds trying to execute the agent configuration or running the agent.</p><p>To avoid explicit display of environment variables in Azure Pipeline logs, the Task sets the environment variables and instructs Docker to forward those to the container.
Remember that the values will be easily accessible from the host machine. Typing <code>docker inspect dotnet-core-2.2</code> outputs all environment variables, including <code>AZP_TOKEN</code> (see below).</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml>[
    {
        <span style=color:#66d9ef>&#34;Id&#34;: </span><span style=color:#e6db74>&#34;73dab022f7c304a6f9e7db6d8d83464b2b4e269c7a894436868135bd52c9ee19&#34;</span>,
        <span style=color:#66d9ef>&#34;Created&#34;: </span><span style=color:#e6db74>&#34;2019-07-13T21:06:09.1351118Z&#34;</span>,
        <span style=color:#66d9ef>&#34;Name&#34;: </span><span style=color:#e6db74>&#34;/dotnet-core-2.2&#34;</span>,
        <span style=color:#66d9ef>&#34;Platform&#34;: </span><span style=color:#e6db74>&#34;windows&#34;</span>,
        <span style=color:#66d9ef>&#34;Config&#34;: </span>{
            <span style=color:#66d9ef>&#34;Hostname&#34;: </span><span style=color:#e6db74>&#34;73dab022f7c3&#34;</span>,
...omiss...
            <span style=color:#66d9ef>&#34;Env&#34;: </span>[
                <span style=color:#e6db74>&#34;AZP_URL=https://dev.azure.com/giuliovaad/&#34;</span>,
                <span style=color:#e6db74>&#34;AZP_TOKEN=p**************************************************q&#34;</span>,
                <span style=color:#e6db74>&#34;AZP_POOL=Default&#34;</span>,
                <span style=color:#e6db74>&#34;AZP_AGENT_NAME=dotnet-core-2.2&#34;</span>,
                <span style=color:#e6db74>&#34;dotnetcore_2.2=true&#34;</span>,
                <span style=color:#e6db74>&#34;AZP_WORK=_work&#34;</span>,
                <span style=color:#e6db74>&#34;VSO_AGENT_IGNORE=VSO_AGENT_IGNORE,AZP_AGENT_NAME,AZP_URL,AZP_TOKEN,AZP_POOL&#34;</span>
            ],
        },
...omiss...
    }
]
</code></pre></div><h3 id=using-the-template>Using the Template</h3><p>The pipeline invokes the same template passing which agent we want to start. The <code>os_tag</code> is necessary to match the host.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#66d9ef>trigger</span>:
  <span style=color:#66d9ef>batch</span>: <span style=color:#66d9ef>true</span>
  <span style=color:#66d9ef>paths</span>:
    <span style=color:#66d9ef>include</span>:
      - src/agents/*
<span style=color:#66d9ef>jobs</span>:
- <span style=color:#66d9ef>template</span>: templates/deploy-image.yaml
  <span style=color:#66d9ef>parameters</span>:
    <span style=color:#66d9ef>os</span>: <span style=color:#e6db74>&#39;windows&#39;</span>
    <span style=color:#66d9ef>os_tag</span>: <span style=color:#e6db74>&#39;Windows_NT&#39;</span>
    <span style=color:#66d9ef>toolchain</span>: <span style=color:#e6db74>&#39;dotnet-core&#39;</span>
    <span style=color:#66d9ef>toolchain_version</span>: <span style=color:#e6db74>&#39;2.2&#39;</span>
- <span style=color:#66d9ef>template</span>: templates/deploy-image.yaml
  <span style=color:#66d9ef>parameters</span>:
    <span style=color:#66d9ef>os</span>: <span style=color:#e6db74>&#39;linux&#39;</span>
    <span style=color:#66d9ef>toolchain</span>: <span style=color:#e6db74>&#39;angular&#39;</span>
    <span style=color:#66d9ef>toolchain_version</span>: <span style=color:#e6db74>&#39;ng&#39;</span>
</code></pre></div><p>Each template invocation runs in parallel, being a Pipeline Job.</p><p>If you want to start additional copies of the same agent, use the <code>container_name_suffix</code> parameter to make the name unique. For example you can add this invocation to the above pipeline.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml>- <span style=color:#66d9ef>template</span>: templates/deploy-image.yaml
  <span style=color:#66d9ef>parameters</span>:
    <span style=color:#66d9ef>os</span>: <span style=color:#e6db74>&#39;windows&#39;</span>
    <span style=color:#66d9ef>os_tag</span>: <span style=color:#e6db74>&#39;Windows_NT&#39;</span>
    <span style=color:#66d9ef>toolchain</span>: <span style=color:#e6db74>&#39;dotnet-core&#39;</span>
    <span style=color:#66d9ef>toolchain_version</span>: <span style=color:#e6db74>&#39;2.2&#39;</span>
    <span style=color:#66d9ef>container_name_suffix</span>: <span style=color:#e6db74>&#39;_bis&#39;</span>
</code></pre></div><p>You can organize your pipelines in a different way to avoid restarting all the agents more or less at the same time. For example you can use a build definition for each agent toolchain.</p><h3 id=secret-variable-for-pat>Secret variable for PAT</h3><p>The template requires an Azure DevOps Personal Access Token or PAT to register an agent in the Pool. The PAT must have <em>Read & manage</em> permission at <em>Agent Pools</em> scope.</p><p><figure class=image-caption><a href=/2019/09/13/meta-pipelines-part-4-deploy-and-run/MakeAgents-PAT.png><img loading=lazy height=528 width=695 style=max-width:100%;height:auto srcset="/2019/09/13/meta-pipelines-part-4-deploy-and-run/MakeAgents-PAT_hue3b85c9cfe108a57f732487fd61b663d_17975_500x0_resize_box_2.png 500w, /2019/09/13/meta-pipelines-part-4-deploy-and-run/MakeAgents-PAT.png 800w," src=/2019/09/13/meta-pipelines-part-4-deploy-and-run/MakeAgents-PAT.png alt="Add a PAT with proper permission"></a><figcaption></figcaption></figure></p><p>This variable cannot be defined in YAML and must be added to the Pipeline Definition manually.</p><p><figure class=image-caption><a href=/2019/09/13/meta-pipelines-part-4-deploy-and-run/PAT-variable-1.png><img loading=lazy height=184 width=804 style=max-width:100%;height:auto srcset="/2019/09/13/meta-pipelines-part-4-deploy-and-run/PAT-variable-1_hubb22cb530402ed5cb107914635bda117_11616_500x0_resize_box_2.png 500w, /2019/09/13/meta-pipelines-part-4-deploy-and-run/PAT-variable-1_hubb22cb530402ed5cb107914635bda117_11616_800x0_resize_box_2.png 800w, /2019/09/13/meta-pipelines-part-4-deploy-and-run/PAT-variable-1.png 1200w," src=/2019/09/13/meta-pipelines-part-4-deploy-and-run/PAT-variable-1.png alt="Edit Pipeline"></a><figcaption></figcaption></figure></p><p><figure class=image-caption><a href=/2019/09/13/meta-pipelines-part-4-deploy-and-run/PAT-variable-2.png><img loading=lazy height=224 width=805 style=max-width:100%;height:auto srcset="/2019/09/13/meta-pipelines-part-4-deploy-and-run/PAT-variable-2_hu562200fda1ab92c5ad4445cfe9ede1b3_18554_500x0_resize_box_2.png 500w, /2019/09/13/meta-pipelines-part-4-deploy-and-run/PAT-variable-2_hu562200fda1ab92c5ad4445cfe9ede1b3_18554_800x0_resize_box_2.png 800w, /2019/09/13/meta-pipelines-part-4-deploy-and-run/PAT-variable-2.png 1200w," src=/2019/09/13/meta-pipelines-part-4-deploy-and-run/PAT-variable-2.png alt="Select Variables from &amp;hellip; menu"></a><figcaption></figcaption></figure></p><p><figure class=image-caption><a href=/2019/09/13/meta-pipelines-part-4-deploy-and-run/PAT-variable-3.png><img loading=lazy height=409 width=1501 style=max-width:100%;height:auto srcset="/2019/09/13/meta-pipelines-part-4-deploy-and-run/PAT-variable-3_hu0a14fa65f6c81f0aae038fb7cbbf1b9d_31250_500x0_resize_box_2.png 500w, /2019/09/13/meta-pipelines-part-4-deploy-and-run/PAT-variable-3_hu0a14fa65f6c81f0aae038fb7cbbf1b9d_31250_800x0_resize_box_2.png 800w, /2019/09/13/meta-pipelines-part-4-deploy-and-run/PAT-variable-3_hu0a14fa65f6c81f0aae038fb7cbbf1b9d_31250_1200x0_resize_box_2.png 1200w, /2019/09/13/meta-pipelines-part-4-deploy-and-run/PAT-variable-3_hu0a14fa65f6c81f0aae038fb7cbbf1b9d_31250_1500x0_resize_box_2.png 1500w," src=/2019/09/13/meta-pipelines-part-4-deploy-and-run/PAT-variable-3.png alt="Add AZURE_DEVOPS_PAT variable"></a><figcaption></figcaption></figure></p><p><figure class=image-caption><a href=/2019/09/13/meta-pipelines-part-4-deploy-and-run/PAT-variable-4.png><img loading=lazy height=409 width=1501 style=max-width:100%;height:auto srcset="/2019/09/13/meta-pipelines-part-4-deploy-and-run/PAT-variable-4_hu489b83c5c295dd6b8d6f6ef35c22200c_28767_500x0_resize_box_2.png 500w, /2019/09/13/meta-pipelines-part-4-deploy-and-run/PAT-variable-4_hu489b83c5c295dd6b8d6f6ef35c22200c_28767_800x0_resize_box_2.png 800w, /2019/09/13/meta-pipelines-part-4-deploy-and-run/PAT-variable-4_hu489b83c5c295dd6b8d6f6ef35c22200c_28767_1200x0_resize_box_2.png 1200w, /2019/09/13/meta-pipelines-part-4-deploy-and-run/PAT-variable-4_hu489b83c5c295dd6b8d6f6ef35c22200c_28767_1500x0_resize_box_2.png 1500w," src=/2019/09/13/meta-pipelines-part-4-deploy-and-run/PAT-variable-4.png alt="Make it Secret and Settable at Queue time"></a><figcaption></figcaption></figure></p><p>Keep in mind that this variable is easily accessible from the Host machine using <code>docker inspect</code> command.</p><h2 id=whats-next>What&rsquo;s next</h2><p>If we run the above pipeline successfully, we should see, in Azure Pipelines <em>Default</em> Agent Pool, two additional agents.</p><p><figure class=image-caption><a href=/2019/09/13/meta-pipelines-part-4-deploy-and-run/agents-started-by-pipeline.png><img loading=lazy height=458 width=965 style=max-width:100%;height:auto srcset="/2019/09/13/meta-pipelines-part-4-deploy-and-run/agents-started-by-pipeline_hu28421b80cec21c382109a6fe36d98dca_16799_500x0_resize_box_2.png 500w, /2019/09/13/meta-pipelines-part-4-deploy-and-run/agents-started-by-pipeline_hu28421b80cec21c382109a6fe36d98dca_16799_800x0_resize_box_2.png 800w, /2019/09/13/meta-pipelines-part-4-deploy-and-run/agents-started-by-pipeline.png 1200w," src=/2019/09/13/meta-pipelines-part-4-deploy-and-run/agents-started-by-pipeline.png alt="Two running agents in Default Pool started by Pipeline"></a><figcaption></figcaption></figure></p><p>In future posts we will use go back to the host machines and try to automate those too.</p></p></div><div class=card-footer><small class=text-muted><i class="fas fa-folder text-primary"></i>&nbsp;
<a href=/categories/#devops class="badge badge-primary"><span>DevOps</span></a><br><i class="fas fa-tags text-secondary"></i>&nbsp;
<a href=/tags/#build class="badge badge-secondary"><span>Build</span></a>
<a href=/tags/#pipelines class="badge badge-secondary"><span>Pipelines</span></a>
<a href=/tags/#azure-devops class="badge badge-secondary"><span>Azure DevOps</span></a>
<a href=/tags/#docker class="badge badge-secondary"><span>Docker</span></a></small></div></div></div></main><footer class="navbar-light border-top"><div class=container><div class=row><div class="col-12 col-md-3 mb-3"><h5>Giulio Vian's Blog!</h5>Notes and considerations of small venetian guy on DevOps tools, architecture, development and other paraphernalia.</div><div class="col-12 col-md-3 mb-3"><h5>Social</h5><ul class="list-unstyled list-inline"><li class=list-inline-item><a href=https://github.com/giuliov target=_blank rel="noopener noreferrer" title=GitHub class="fab fa-github fa-2x"></a></li><li class=list-inline-item><a href=https://stackoverflow.com/users/100864 target=_blank rel="noopener noreferrer" title="Stack Overflow" class="fab fa-stack-overflow fa-2x"></a></li><li class=list-inline-item><a href=https://medium.com/@giuliovdev target=_blank rel="noopener noreferrer" title=Medium class="fab fa-medium fa-2x"></a></li><li class=list-inline-item><a href=https://linkedin.com/in/giuliovian target=_blank rel="noopener noreferrer" title=LinkedIn class="fab fa-linkedin fa-2x"></a></li><li class=list-inline-item><a href=https://linkedin.com/company/unum-ireland-ltd-it target=_blank rel="noopener noreferrer" title="LinkedIn Company" class="fab fa-linkedin fa-2x"></a></li><li class=list-inline-item><a href=https://xing.com/profile/Giulio_Vian target=_blank rel="noopener noreferrer" title=Xing class="fab fa-xing fa-2x"></a></li><li class=list-inline-item><a href=https://slideshare.net/giuliov target=_blank rel="noopener noreferrer" title=SlideShare class="fab fa-slideshare fa-2x"></a></li><li class=list-inline-item><a href=https://youtube.com/UCZ-J6JRyvz6aaJ9zCN5wpxA target=_blank rel="noopener noreferrer" title=YouTube class="fab fa-youtube fa-2x"></a></li><li class=list-inline-item><a href=https://twitter.com/giulio_vian target=_blank rel="noopener noreferrer" title=Twitter class="fab fa-twitter fa-2x"></a></li><li class=list-inline-item><a href=mailto:giulio.dev@casavian.eu title=Email class="fas fa-envelope fa-2x"></a></li></ul></div><div class="col-12 col-md-3 mb-3"><h5>Site</h5><ul class=list-unstyled><li><a href=/about/><i class="fas fa-address-card"></i>About</a></li><li><a href=/categories/><i class="fas fa-folder"></i>Categories</a></li><li><a href=/series/><i class="fas fa-book"></i>Series</a></li><li><a href=/tags/><i class="fas fa-tags"></i>Tags</a></li></ul></div><div class="col-12 col-md-3 mb-3">&copy; 2020 Giulio Vian<br>Theme by <a href=https://www.spech.de target=_blank rel="noopener noreferrer">Sebastian Pech</a>.</div></div></div></footer><script src=/js/vendor.min.0497fa926ed3dc2241b91e016467480841da9749a0f7c40ed3960c3c238745e5accb5ec5e07654668e11047bbf96f95083b88dd49a845781011aba42e4f00a5d.js integrity="sha512-BJf6km7T3CJBuR4BZGdICEHal0mg98QO05YMPCOHReWsy17F4HZUZo4RBHu/lvlQg7iN1JqEV4EBGrpC5PAKXQ=="></script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-46796059-1','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script></body></html>