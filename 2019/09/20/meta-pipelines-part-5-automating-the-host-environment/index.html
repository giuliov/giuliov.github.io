<!doctype html><html lang=en><meta charset=utf-8><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"http:\/\/blog.casavian.eu\/"},"articleSection":"post","name":"Meta-pipelines - Part 5 - Automating the Host Environment","headline":"Meta-pipelines - Part 5 - Automating the Host Environment","description":"Notes and considerations of small venetian guy on DevOps tools, architecture, development and other paraphernalia.","inLanguage":"en","author":"Giulio Vian","creator":"Giulio Vian","publisher":"Giulio Vian","accountablePerson":"Giulio Vian","copyrightHolder":"Giulio Vian","copyrightYear":"2019","datePublished":"2019-09-20T00:00:00Z","dateModified":"2019-09-20T00:00:00Z","url":"\/2019\/09\/20\/meta-pipelines-part-5-automating-the-host-environment\/","wordCount":"1486","keywords":["Build","Pipelines","Azure DevOps","Terraform","Blog"]}</script><title>Meta-pipelines - Part 5 - Automating the Host Environment &ndash; Giulio Vian's Blog!</title><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=description content="Notes and considerations of small venetian guy on DevOps tools, architecture, development and other paraphernalia."><meta name=author content="Giulio Vian"><link rel=icon href=/favicon.ico><meta itemprop=name content="Meta-pipelines - Part 5 - Automating the Host Environment"><meta itemprop=description content="Looking back at the previous parts of this series, we have been able to manually setup two hosts, a Windows one and a Linux one, and a simple pipeline to automatically deploy new Azure DevOps/TFS Agents in Docker containers on such hosts and even update them.
In this post we will look how to provision the hosts themselves. For this purpose we will use Terraform and invoke it from Azure Pipelines so we can automate host creation in Azure."><meta itemprop=datePublished content="2019-09-20T00:00:00+00:00"><meta itemprop=dateModified content="2019-09-20T00:00:00+00:00"><meta itemprop=wordCount content="1486"><meta itemprop=image content="http://blog.casavian.eu/2019/09/20/meta-pipelines-part-5-automating-the-host-environment/feature-banner.jpg"><meta itemprop=keywords content="Build,Pipelines,Azure DevOps,Terraform,"><meta property="og:title" content="Meta-pipelines - Part 5 - Automating the Host Environment"><meta property="og:description" content="Looking back at the previous parts of this series, we have been able to manually setup two hosts, a Windows one and a Linux one, and a simple pipeline to automatically deploy new Azure DevOps/TFS Agents in Docker containers on such hosts and even update them.
In this post we will look how to provision the hosts themselves. For this purpose we will use Terraform and invoke it from Azure Pipelines so we can automate host creation in Azure."><meta property="og:type" content="article"><meta property="og:url" content="http://blog.casavian.eu/2019/09/20/meta-pipelines-part-5-automating-the-host-environment/"><meta property="og:image" content="http://blog.casavian.eu/2019/09/20/meta-pipelines-part-5-automating-the-host-environment/feature-banner.jpg"><meta property="article:published_time" content="2019-09-20T00:00:00+00:00"><meta property="article:modified_time" content="2019-09-20T00:00:00+00:00"><meta property="og:site_name" content="Giulio Vian's Blog!"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="http://blog.casavian.eu/2019/09/20/meta-pipelines-part-5-automating-the-host-environment/feature-banner.jpg"><meta name=twitter:title content="Meta-pipelines - Part 5 - Automating the Host Environment"><meta name=twitter:description content="Looking back at the previous parts of this series, we have been able to manually setup two hosts, a Windows one and a Linux one, and a simple pipeline to automatically deploy new Azure DevOps/TFS Agents in Docker containers on such hosts and even update them.
In this post we will look how to provision the hosts themselves. For this purpose we will use Terraform and invoke it from Azure Pipelines so we can automate host creation in Azure."><meta name=twitter:site content="@giulio_vian"><link rel=alternate href=/index.xml type=application/rss+xml title="Giulio Vian's Blog!"><link rel=stylesheet href=/css/vendor.min.95b0b4c4607aec507f0fc9d9c36a12a4613ccac06f9423caa43e265cb58eb5f90709388cc0fa166ac3ca836b4163e6d0569b8b86065d9cabdf223c5ea9a63b08.css integrity="sha512-lbC0xGB67FB/D8nZw2oSpGE8ysBvlCPKpD4mXLWOtfkHCTiMwPoWasPKg2tBY+bQVpuLhgZdnKvfIjxeqaY7CA=="><link href=http://blog.casavian.eu/css/cookieconsent.min.cd0d0b6e50ff01ff2f3a9a70d7cfb66a7c6cb9acf7a566325568be6d3bd31fc4.css rel=stylesheet type=text/css integrity="sha256-zQ0LblD/Af8vOppw18+2anxsuaz3pWYyVWi+bTvTH8Q=" crossorigin=anonymous><script src=http://blog.casavian.eu/js/cookieconsent.min.e55842a856a6d829feca3c3ad736c136b6c7549e9247274f78aa296259e06e24.js integrity="sha256-5VhCqFam2Cn+yjw61zbBNrbHVJ6SRydPeKopYlngbiQ=" crossorigin=anonymous async></script><script>window.addEventListener("load",function(){window.cookieconsent.initialise({"palette":{"popup":{"background":"#428bca","text":"#ffffff"},"button":{"background":"#f71559"}},"content":{"message":'This website uses cookies.',"dismiss":'Got it!',"link":'Learn more.',"href":"http:\/\/blog.casavian.eu\/page\/privacy-cookies-policy\/"},"position":"bottom-right"})});</script><body><nav class="navbar navbar-light bg-white navbar-expand-lg border-bottom"><div class=container><a class="navbar-brand text-primary" href=/>Giulio Vian's Blog!</a>
<button class="navbar-toggler collapsed" type=button data-toggle=collapse data-target=#navbarCollapse aria-controls=navbarCollapse aria-expanded=false aria-label="Toggle navigation">
<span class=navbar-toggler-icon></span></button><div class="navbar-collapse collapse" id=navbarCollapse><ul class="navbar-nav mr-auto"><li class=nav-item><a class="nav-link text-primary" href=/index.html><i class="fas fa-home"></i>Home</a></li><li class=nav-item><a class="nav-link text-primary" href=/page/about/><i class="fa fa-info-circle"></i>About</a></li><li class=nav-item><a class="nav-link text-primary" href=/page/public-speaking><i class="fa fa-microphone"></i>Speaking</a></li><li class=nav-item><a class="nav-link text-primary" href=/it><i class="fa fa-language"></i>Italian</a></li></ul></div></div></nav><main role=main><div class="container mt-3 mb-3"><div class=card><img class=card-img-top src=/2019/09/20/meta-pipelines-part-5-automating-the-host-environment/feature-banner_hu34c3e573966966cb30c13e11fba0381d_392742_1108x0_resize_q75_box.jpg alt="Meta-pipelines - Part 5 - Automating the Host Environment" title="Meta-pipelines - Part 5 - Automating the Host Environment"><div class=card-body><h1 class=card-title><a href=/2019/09/20/meta-pipelines-part-5-automating-the-host-environment/>Meta-pipelines - Part 5 - Automating the Host Environment</a></h1><h6 class="card-subtitle mb-2 text-muted"><i class="fas fa-calendar-day"></i>&nbsp;20 Sep 2019 -
<i class="fas fa-user"></i>&nbsp;Giulio Vian
- <i class="fas fa-clock"></i>&nbsp;~7 Minutes</h6><p class=card-text><p>Looking back at the previous parts of this series, we have been able to manually setup two hosts, a Windows one and a Linux one, and a simple pipeline to automatically deploy new Azure DevOps/TFS Agents in Docker containers on such hosts and even update them.</p><p>In this post we will look how to provision the hosts themselves. For this purpose we will use Terraform and invoke it from Azure Pipelines so we can automate host creation in Azure.</p><p>If you need a Terraform primer there is plenty of resources, from the excellent <a href=https://www.terraformupandrunning.com/ target=_blank rel="noopener noreferrer">Terraform: Up & Running
&nbsp;<i class="fas fa-external-link-alt"></i></a> to the <a href=https://www.terraform.io/docs/index.html target=_blank rel="noopener noreferrer">official documentation
&nbsp;<i class="fas fa-external-link-alt"></i>
</a>, Pluralsight courses, etc. I recommend to have at least a cursory knowledge of Terraform and Azure before delving deeper.</p><h2 id=blueprinting>Blueprinting</h2><p>Terraform will provision the virtual machines to host our Docker containers. The full source code is in the <a href=https://github.com/giuliov/pipeline-your-pipelines target=_blank rel="noopener noreferrer">repository
&nbsp;<i class="fab fa-github"></i>
</a>, here we will highlight and comment some major points to avoid listing all 500+ lines of code.</p><p>Note that I used Terraform 0.12 which allows for a different, more elegant language grammar.</p><h3 id=azure-architecture>Azure Architecture</h3><p>The blueprint will have a Resource Group for these Hosts, two sets of Virtual Machines (VMs), one for Windows, one for Linux, an Azure Container Registry to store the agent images and a Key Vault for passwords and certificates.<figure class=image-caption><a href=/2019/09/20/meta-pipelines-part-5-automating-the-host-environment/PYP-architecture.png><img loading=lazy height=410 width=555 style=max-width:100%;height:auto srcset="/2019/09/20/meta-pipelines-part-5-automating-the-host-environment/PYP-architecture_hueadfc2f759048c1005162a048ec6d77a_21897_500x0_resize_box_2.png 500w, /2019/09/20/meta-pipelines-part-5-automating-the-host-environment/PYP-architecture.png 800w," src=/2019/09/20/meta-pipelines-part-5-automating-the-host-environment/PYP-architecture.png alt="Azure architecture"></a><figcaption></figcaption></figure>Each set of VM lives in its own Subnet and respective Network Security Group.</p><p>Terraform needs a Service Principal (SP for short), a type of Azure Active Directory (AAD) account, to authenticate. The simplest way to create one is using <a href="https://docs.microsoft.com/en-us/cli/azure/create-an-azure-service-principal-azure-cli?view=azure-cli-latest" target=_blank rel="noopener noreferrer">Azure CLI
&nbsp;<i class="fas fa-external-link-alt"></i></a> or <a href="https://docs.microsoft.com/en-us/powershell/azure/create-azure-service-principal-azureps?view=azps-2.4.0" target=_blank rel="noopener noreferrer">Azure PowerShell
&nbsp;<i class="fas fa-external-link-alt"></i>
</a>.</p><p>By running similar commands, create the SP. Take note of the output values for Terraform.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>az account list
<span style=color:#75715e># take note of output, e.g.</span>
<span style=color:#75715e>#   [</span>
<span style=color:#75715e>#     {</span>
<span style=color:#75715e>#       &#34;cloudName&#34;: &#34;AzureCloud&#34;,</span>
<span style=color:#75715e>#       &#34;id&#34;: &#34;9cc84c88-b440-42ee-8847-89249a7d67c2&#34;,</span>
<span style=color:#75715e>#       &#34;isDefault&#34;: true,</span>
<span style=color:#75715e>#       &#34;name&#34;: &#34;My Magic Azure Subscription&#34;,</span>
<span style=color:#75715e>#       &#34;state&#34;: &#34;Enabled&#34;,</span>
<span style=color:#75715e>#       &#34;tenantId&#34;: &#34;c6f5c7b6-353c-4af6-8d95-314c58f1fec2&#34;,</span>
<span style=color:#75715e>#       &#34;user&#34;: {</span>
<span style=color:#75715e>#         &#34;cloudShellID&#34;: true,</span>
<span style=color:#75715e>#         &#34;name&#34;: &#34;live.com#my_msa_account@outlook.com&#34;,</span>
<span style=color:#75715e>#         &#34;type&#34;: &#34;user&#34;</span>
<span style=color:#75715e>#       }</span>
<span style=color:#75715e>#     }</span>
<span style=color:#75715e>#   ]</span>
#
<span style=color:#75715e>#   id          -&gt; AZURE_SUBSCRIPTION_ID</span>
<span style=color:#75715e>#   tenantId    -&gt; AZURE_TENANT_ID</span>
az ad sp create-for-rbac --name AggregatorSPLimitedToTestRG
<span style=color:#75715e># take note of output, e.g.</span>
<span style=color:#75715e>#   {</span>
<span style=color:#75715e>#     &#34;appId&#34;: &#34;56f7583c-4165-43c5-8311-f2e671aa1fdd&#34;,</span>
<span style=color:#75715e>#     &#34;displayName&#34;: &#34;MyTerraformServicePrincipal&#34;,</span>
<span style=color:#75715e>#     &#34;name&#34;: &#34;http://MyTerraformServicePrincipal&#34;,</span>
<span style=color:#75715e>#     &#34;password&#34;: &#34;************************************&#34;,</span>
<span style=color:#75715e>#     &#34;tenant&#34;: &#34;c6f5c7b6-353c-4af6-8d95-314c58f1fec2&#34;</span>
<span style=color:#75715e>#   }</span>
<span style=color:#75715e>#   appId       -&gt; AZURE_CLIENT_ID</span>
<span style=color:#75715e>#   password    -&gt; AZURE_CLIENT_SECRET</span>
<span style=color:#75715e>#   tenant      -&gt; AZURE_TENANT_ID</span>
</code></pre></div><p>These scripts are controlled by a number of variables, described in the next table.</p><table><thead><tr><th>variable</th><th>use</th><th>default</th></tr></thead><tbody><tr><td>env_name</td><td>Name of Environment</td><td>pyp-demo</td></tr><tr><td>resource_group_location</td><td>Azure Region of resources</td><td>westeurope</td></tr><tr><td>acr_sku</td><td>SKU of Azure Container Registry</td><td>Basic</td></tr><tr><td>num_windows_hosts</td><td>Number of Windows VMs</td><td>1</td></tr><tr><td>num_linux_hosts</td><td>Number of Linux VMs</td><td>1</td></tr><tr><td>vm_size</td><td>Size of VMs (1)</td><td>Standard_B1</td></tr><tr><td>vm_disk_type</td><td>Type of disk storage for VMs (1)</td><td>Standard_LRS</td></tr><tr><td>vm_admin_username</td><td>Username for the Administrator account</td><td>hostadmin</td></tr><tr><td>vm_public_access</td><td>If true the Security Groups allow RDP and SSH access to the VMs</td><td>false</td></tr><tr><td>azuredevops_pat</td><td>Azure DevOps Personal Access Token (2)</td><td>—</td></tr><tr><td>azuredevops_url</td><td>Azure DevOps URL</td><td>—</td></tr><tr><td>azuredevops_pool_hosts</td><td>Azure DevOps Pool for Hosts</td><td>—</td></tr></tbody></table><p>(1) Default size is the cheapest, which may not be adequate for production usage.
(2) Must have Read & Manage permission at Agent Pools scope.</p><p>Additional tuning requires changing the Terraform source code.</p><p>Some resource names are global to the whole Azure because they become part of DNS names; in our case the Registry (ACR) and KeyVault must be unique. To guarantee this we add a random 6 character string to the base name; in addition punctuation symbols are forbidden. Here is the code for it.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-terraform data-lang=terraform><span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;random_id&#34; &#34;env_name&#34;</span> {
<span style=color:#a6e22e>  keepers</span> <span style=color:#f92672>=</span> {
<span style=color:#a6e22e>    env_name</span> <span style=color:#f92672>=</span> <span style=color:#960050;background-color:#1e0010>var</span>.<span style=color:#960050;background-color:#1e0010>env_name</span>
  }

<span style=color:#a6e22e>  byte_length</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>3</span>
}

<span style=color:#960050;background-color:#1e0010>locals</span> {
<span style=color:#a6e22e>  env_name_nosymbols</span> <span style=color:#f92672>=</span> <span style=color:#960050;background-color:#1e0010>replace</span>(<span style=color:#960050;background-color:#1e0010>replace</span>(<span style=color:#960050;background-color:#1e0010>var</span>.<span style=color:#960050;background-color:#1e0010>env_name</span>, <span style=color:#e6db74>&#34;-&#34;, &#34;&#34;), &#34;_&#34;, &#34;&#34;</span>)
<span style=color:#a6e22e>  name_suffix</span>        <span style=color:#f92672>=</span> <span style=color:#960050;background-color:#1e0010>random_id</span>.<span style=color:#960050;background-color:#1e0010>env_name</span>.<span style=color:#960050;background-color:#1e0010>hex</span>
}

<span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;azurerm_container_registry&#34; &#34;pyp&#34;</span> {
<span style=color:#a6e22e>  name</span>                <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;${local.env_name_nosymbols}${local.name_suffix}&#34;</span><span style=color:#75715e>
</span><span style=color:#75715e>  #...omissis...
</span><span style=color:#75715e></span>}
<span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;azurerm_key_vault&#34; &#34;pyp&#34;</span> {
<span style=color:#a6e22e>  name</span>                <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;${local.env_name_nosymbols}${local.name_suffix}&#34;</span><span style=color:#75715e>
</span><span style=color:#75715e>  #...omissis...
</span><span style=color:#75715e></span>}
</code></pre></div><p>The <em>keepers</em> argument ties the generation of a new random number to <code>env_name</code> value. Only if this latter changes, a new number is generated.</p><p>To configure the virtual machines we use an initialization script: <code>windows-setup.ps1</code> and <code>ubuntu-setup.sh</code>.</p><p>They are similar in following these steps:</p><ol><li>Preparing the data disk</li><li>Installing Docker</li><li>Reconfiguring the Docker daemon to use the data volume for its operations</li><li>Install PowerShell 6 & Git</li><li>Install and configure the Azure Pipelines Agent</li></ol><h3 id=launching-windows-setup>Launching Windows setup</h3><p>The fragment that launches the setup script uses OOBE, a native Windows mechanism for initial OS configuration.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-terraform data-lang=terraform><span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;azurerm_virtual_machine&#34; &#34;windows_vm&#34;</span> {
  <span style=color:#960050;background-color:#1e0010>os_profile</span> {<span style=color:#75715e>
</span><span style=color:#75715e>    # CAVEAT: Careful to stay within 64 KB limit for the custom data block
</span><span style=color:#75715e></span><span style=color:#a6e22e>    custom_data</span> <span style=color:#f92672>=</span><span style=color:#a6e22e> &#34;Param($AZP_URL</span><span style=color:#f92672>=</span><span style=color:#a6e22e>&#39;${var.azuredevops_url}&#39;,$AZP_TOKEN</span><span style=color:#f92672>=</span><span style=color:#a6e22e>&#39;${var.azuredevops_pat}&#39;,$AZP_POOL</span><span style=color:#f92672>=</span><span style=color:#960050;background-color:#1e0010>&#39;</span><span style=color:#e6db74>${</span><span style=color:#960050;background-color:#1e0010>var</span>.<span style=color:#960050;background-color:#1e0010>azuredevops_pool_hosts</span><span style=color:#e6db74>}</span><span style=color:#960050;background-color:#1e0010>&#39;</span>) <span style=color:#e6db74>${</span>file(<span style=color:#e6db74>&#34;${path.module}/scripts/windows-setup.ps1&#34;)}&#34;</span>
  <span style=color:#e6db74>}</span>

  <span style=color:#960050;background-color:#1e0010>os_profile_windows_config</span> {<span style=color:#75715e>
</span><span style=color:#75715e>    # Auto-Login&#39;s required to configure machine
</span><span style=color:#75715e></span>    <span style=color:#960050;background-color:#1e0010>additional_unattend_config</span> {
<span style=color:#a6e22e>      pass</span>         <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;oobeSystem&#34;</span>
<span style=color:#a6e22e>      component</span>    <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Microsoft-Windows-Shell-Setup&#34;</span>
<span style=color:#a6e22e>      setting_name</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;AutoLogon&#34;</span>
<span style=color:#a6e22e>      content</span>      <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;&lt;AutoLogon&gt;&lt;Password&gt;&lt;Value&gt;${random_string.vm_admin_password.result}&lt;/Value&gt;&lt;/Password&gt;&lt;Enabled&gt;true&lt;/Enabled&gt;&lt;LogonCount&gt;1&lt;/LogonCount&gt;&lt;Username&gt;${var.vm_admin_username}&lt;/Username&gt;&lt;/AutoLogon&gt;&#34;</span>
    }

    <span style=color:#960050;background-color:#1e0010>additional_unattend_config</span> {
<span style=color:#a6e22e>      pass</span>         <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;oobeSystem&#34;</span>
<span style=color:#a6e22e>      component</span>    <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Microsoft-Windows-Shell-Setup&#34;</span>
<span style=color:#a6e22e>      setting_name</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;FirstLogonCommands&#34;</span>
<span style=color:#a6e22e>      content</span>      <span style=color:#f92672>=</span> <span style=color:#960050;background-color:#1e0010>file</span>(<span style=color:#e6db74>&#34;${path.module}/scripts/FirstLogonCommands.xml&#34;</span>)
    }
  }<span style=color:#75715e>
</span><span style=color:#75715e>  # ... omissis ...
</span></code></pre></div><p><code>path.module</code> translates to the directory where the Terraform source is located.</p><p><code>FirstLogonCommands.xml</code> lists a few actions to take, the last one launches our powershell script.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=color:#f92672>&lt;FirstLogonCommands&gt;</span>
    <span style=color:#f92672>&lt;SynchronousCommand&gt;</span>
        <span style=color:#f92672>&lt;CommandLine&gt;</span>cmd /c &#34;mkdir C:\terraform&#34;<span style=color:#f92672>&lt;/CommandLine&gt;</span>
        <span style=color:#f92672>&lt;Description&gt;</span>Create the Terraform working directory<span style=color:#f92672>&lt;/Description&gt;</span>
        <span style=color:#f92672>&lt;Order&gt;</span>11<span style=color:#f92672>&lt;/Order&gt;</span>
    <span style=color:#f92672>&lt;/SynchronousCommand&gt;</span>
    <span style=color:#f92672>&lt;SynchronousCommand&gt;</span>
        <span style=color:#f92672>&lt;CommandLine&gt;</span>cmd /c &#34;copy C:\AzureData\CustomData.bin C:\terraform\windows-setup.ps1&#34;<span style=color:#f92672>&lt;/CommandLine&gt;</span>
        <span style=color:#f92672>&lt;Description&gt;</span>Move the CustomData file to the working directory<span style=color:#f92672>&lt;/Description&gt;</span>
        <span style=color:#f92672>&lt;Order&gt;</span>12<span style=color:#f92672>&lt;/Order&gt;</span>
    <span style=color:#f92672>&lt;/SynchronousCommand&gt;</span>
    <span style=color:#f92672>&lt;SynchronousCommand&gt;</span>
        <span style=color:#f92672>&lt;CommandLine&gt;</span>powershell.exe -sta -ExecutionPolicy Unrestricted -file C:\terraform\windows-setup.ps1<span style=color:#f92672>&lt;/CommandLine&gt;</span>
        <span style=color:#f92672>&lt;Description&gt;</span>Execute the System Configuration script<span style=color:#f92672>&lt;/Description&gt;</span>
        <span style=color:#f92672>&lt;Order&gt;</span>13<span style=color:#f92672>&lt;/Order&gt;</span>
    <span style=color:#f92672>&lt;/SynchronousCommand&gt;</span>
<span style=color:#f92672>&lt;/FirstLogonCommands&gt;</span>
</code></pre></div><p>This technique works fine in simple scenario like ours, which uses small script, as the <code>custom_data</code> has a hard limit of 64KB.</p><h3 id=windows-setup>Windows setup</h3><p>The script is long but trivial; one interesting line is the Docker <code>storage-opts</code> configuration parameter tuned for Windows images, typically bigger than Linux images.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Powershell data-lang=Powershell><span style=color:#e6db74>&#39;{ &#34;data-root&#34;: &#34;F:\\docker-data&#34;, &#34;storage-opts&#34;: [&#34;size=120GB&#34;] }&#39;</span> | Out-File -Encoding Ascii -Filepath <span style=color:#e6db74>&#34;C:\ProgramData\docker\config\daemon.json&#34;</span>
Restart-Service docker
</code></pre></div><h3 id=launching-linux-setup>Launching Linux setup</h3><p>Linux VM in Azure cannot use custom data and should go for <a href=https://docs.microsoft.com/en-us/azure/virtual-machines/extensions/custom-script-linux target=_blank rel="noopener noreferrer">Custom Script Extension
&nbsp;<i class="fas fa-external-link-alt"></i></a> instead. This translates to the <code>azurerm_virtual_machine_extension</code> Terraform resource.</p><p>I opted for the script property, fed by a template file base-64 encoded, to avoid managing upload of scripts and storage handling.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-terraform data-lang=terraform><span style=color:#a6e22e>  protected_settings</span>   <span style=color:#f92672>=</span> <span style=color:#960050;background-color:#1e0010>&lt;&lt;PROTECTED_SETTINGS</span>
    {
      <span style=color:#e6db74>&#34;script&#34;: &#34;${local.ubuntu_setup_base64}&#34;</span>
    }
<span style=color:#960050;background-color:#1e0010>PROTECTED_SETTINGS</span>
</code></pre></div><h3 id=linux-setup>Linux setup</h3><p>This script has a few tricks:</p><ul><li><code>set -e</code> to fail at first error and <code>-x</code> to log every command</li><li><code>blockdev --rereadpt</code> to make the new partitioned disk visible</li><li><code>-qq -o=Dpkg::Use-Pty=0</code> to minimize apt-get logging</li><li><code>export DEBIAN_FRONTEND=noninteractive</code> to avoid prompting from apt-get</li><li><code>export AGENT_ALLOW_RUNASROOT=1</code></li></ul><p><code>${</code>&mldr;<code>}</code> expression are evaluated by Terraform: this means that the file has secrets in plain text.</p><h2 id=applying-the-blueprint>Applying the blueprint</h2><p>With the Terraform code in hand, we need something to run it with the proper configuration. What&rsquo;s better than an Azure Pipeline? Great! The requirement list includes:</p><ul><li>the Hosted Agents has Terraform, but we need the latest 0.12</li><li>credentials for Terraform remote state</li><li>Azure credentials to pass on to Terraform</li><li>values for Terraform variables</li><li>settings to pass the new agent so it can connect to Azure Pipelines</li></ul><p>This is how each requirement is handled:</p><ul><li>the <a href="https://marketplace.visualstudio.com/items?itemName=charleszipp.azure-pipelines-tasks-terraform" target=_blank rel="noopener noreferrer">Terraform Installer Task
&nbsp;<i class="fas fa-external-link-alt"></i></a> makes sure that the right version of Terraform is installed and the <code>TERRAFORM_VERSION</code> says which version</li><li><code>backend.hcl</code> is a <a href=https://docs.microsoft.com/en-us/azure/devops/pipelines/library/secure-files target=_blank rel="noopener noreferrer">secure file
&nbsp;<i class="fas fa-external-link-alt"></i></a> configures Terraform remote state</li></ul><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-terraform data-lang=terraform><span style=color:#960050;background-color:#1e0010>workspaces</span> {
<span style=color:#a6e22e>  prefix</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;pyp-&#34;</span>
}
<span style=color:#a6e22e>hostname</span>     <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;app.terraform.io&#34;</span>
<span style=color:#a6e22e>organization</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;myorganisation&#34;</span>
<span style=color:#a6e22e>token</span>        <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;**************&#34;</span>

</code></pre></div><p><figure class=image-caption><a href=/2019/09/20/meta-pipelines-part-5-automating-the-host-environment/secure-file.png><img loading=lazy height=232 width=598 style=max-width:100%;height:auto srcset="/2019/09/20/meta-pipelines-part-5-automating-the-host-environment/secure-file_hu12770860ae5339c2181f4d90f9423bfd_24602_500x0_resize_box_2.png 500w, /2019/09/20/meta-pipelines-part-5-automating-the-host-environment/secure-file.png 800w," src=/2019/09/20/meta-pipelines-part-5-automating-the-host-environment/secure-file.png alt="Secure file"></a><figcaption></figcaption></figure></p><ul><li>Four variables (<code>AZURE_SUBSCRIPTION_ID</code>, <code>AZURE_TENANT_ID</code>, <code>AZURE_CLIENT_ID</code>, <code>AZURE_CLIENT_SECRET</code>) defines the Azure credentials for Terraform, see <a href=https://www.terraform.io/docs/providers/azurerm/index.html#argument-reference target=_blank rel="noopener noreferrer">Argument
&nbsp;<i class="fas fa-external-link-alt"></i></a></li><li>Two variables <code>AZUREDEVOPS_PAT</code> and <code>PIPELINE_POOL</code> configures the agent</li><li>the remaining variables set Terraform variables</li></ul><p><figure class=image-caption><a href=/2019/09/20/meta-pipelines-part-5-automating-the-host-environment/terraform-pipeline-vars.png><img loading=lazy height=412 width=960 style=max-width:100%;height:auto srcset="/2019/09/20/meta-pipelines-part-5-automating-the-host-environment/terraform-pipeline-vars_hudb36d540a801d6acc9b160a62fa818a6_49783_500x0_resize_box_2.png 500w, /2019/09/20/meta-pipelines-part-5-automating-the-host-environment/terraform-pipeline-vars_hudb36d540a801d6acc9b160a62fa818a6_49783_800x0_resize_box_2.png 800w, /2019/09/20/meta-pipelines-part-5-automating-the-host-environment/terraform-pipeline-vars.png 1200w," src=/2019/09/20/meta-pipelines-part-5-automating-the-host-environment/terraform-pipeline-vars.png alt="Pipeline variables"></a><figcaption></figcaption></figure></p><p>Here is the Yaml pipeline</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#66d9ef>variables</span>:
  <span style=color:#66d9ef>TERRAFORM_VERSION</span>: <span style=color:#e6db74>&#39;0.12.3&#39;</span>
  <span style=color:#66d9ef>TERRAFORM_WORKSPACE</span>: <span style=color:#e6db74>&#39;dev&#39;</span>
  <span style=color:#66d9ef>TF_IN_AUTOMATION</span>: <span style=color:#66d9ef>true</span>
  <span style=color:#75715e># these variables are commented to remind that they must be defined through the web interface and marked secure</span>
  <span style=color:#75715e># TERRAFORM_REMOTE_TOKEN: &#39;&#39;</span>
  <span style=color:#75715e># AZURE_SUBSCRIPTION_ID: &#39;&#39;</span>
  <span style=color:#75715e># AZURE_TENANT_ID: &#39;&#39;</span>
  <span style=color:#75715e># AZURE_CLIENT_ID: &#39;&#39;</span>
  <span style=color:#75715e># AZURE_CLIENT_SECRET: &#39;&#39;</span>
  <span style=color:#75715e># AZUREDEVOPS_PAT: &#39;&#39;</span>
  <span style=color:#66d9ef>PIPELINE_POOL</span>: <span style=color:#e6db74>&#39;MakeAgents&#39;</span>
  <span style=color:#66d9ef>ENV_NAME</span>: <span style=color:#e6db74>&#39;pyp-demo&#39;</span>
  <span style=color:#66d9ef>RESOURCE_GROUP_LOCATION</span>: <span style=color:#e6db74>&#39;northeurope&#39;</span>
  <span style=color:#66d9ef>ACR_SKU</span>: <span style=color:#e6db74>&#39;Basic&#39;</span>
  <span style=color:#66d9ef>NUM_WINDOWS_HOSTS</span>: <span style=color:#ae81ff>1</span>
  <span style=color:#66d9ef>NUM_LINUX_HOSTS</span>: <span style=color:#ae81ff>1</span>
  <span style=color:#66d9ef>VM_ADMIN_USERNAME</span>: <span style=color:#e6db74>&#39;hostadmin&#39;</span>
  <span style=color:#66d9ef>VM_SIZE</span>: <span style=color:#e6db74>&#39;Standard_B2s&#39;</span>
  <span style=color:#66d9ef>VM_DISK_TYPE</span>: <span style=color:#e6db74>&#39;Standard_LRS&#39;</span>
  <span style=color:#66d9ef>VM_PUBLIC_ACCESS</span>: <span style=color:#66d9ef>true</span>

<span style=color:#66d9ef>steps</span>:
- <span style=color:#66d9ef>task</span>: DownloadSecureFile@<span style=color:#ae81ff>1</span>
  <span style=color:#66d9ef>inputs</span>:
    <span style=color:#66d9ef>secureFile</span>: <span style=color:#e6db74>&#39;backend.hcl&#39;</span>
- <span style=color:#66d9ef>task</span>: charleszipp.azure-pipelines-tasks-terraform.azure-pipelines-tasks-terraform-installer.TerraformInstaller@<span style=color:#ae81ff>0</span>
  <span style=color:#66d9ef>displayName</span>: <span style=color:#e6db74>&#39;Install Terraform $(TERRAFORM_VERSION)&#39;</span>
  <span style=color:#66d9ef>inputs</span>:
    <span style=color:#66d9ef>terraformVersion</span>: <span style=color:#e6db74>&#39;$(TERRAFORM_VERSION)&#39;</span>
- <span style=color:#66d9ef>script</span>: <span style=color:#e6db74>|
</span><span style=color:#e6db74>   terraform init -no-color -input=false -backend-config=&#34;$(Agent.TempDirectory)/backend.hcl&#34;</span>
   terraform apply -no-color -input=<span style=color:#66d9ef>false</span> -auto-approve
  <span style=color:#66d9ef>workingDirectory</span>: <span style=color:#e6db74>&#39;$(System.DefaultWorkingDirectory)/src/hosts/terraform&#39;</span>
  <span style=color:#66d9ef>displayName</span>: <span style=color:#e6db74>&#39;Terraform apply in $(TERRAFORM_WORKSPACE) workspace&#39;</span>
  <span style=color:#66d9ef>env</span>:
    <span style=color:#75715e># forward variables to Terraform</span>
    <span style=color:#66d9ef>TF_WORKSPACE</span>: $(TERRAFORM_WORKSPACE)
    <span style=color:#66d9ef>TF_VAR_azurerm_subscription_id</span>: $(AZURE_SUBSCRIPTION_ID)
    <span style=color:#66d9ef>TF_VAR_azurerm_tenant_id</span>: $(AZURE_TENANT_ID)
    <span style=color:#66d9ef>TF_VAR_azurerm_client_id</span>: $(AZURE_CLIENT_ID)
    <span style=color:#66d9ef>TF_VAR_azurerm_client_secret</span>: $(AZURE_CLIENT_SECRET)
    <span style=color:#66d9ef>TF_VAR_azuredevops_url</span>: $(System.TeamFoundationCollectionUri)
    <span style=color:#66d9ef>TF_VAR_azuredevops_pat</span>: $(AZUREDEVOPS_PAT)
    <span style=color:#66d9ef>TF_VAR_azuredevops_pool_hosts</span>: $(PIPELINE_POOL)
    <span style=color:#66d9ef>TF_VAR_env_name</span>: $(ENV_NAME)
    <span style=color:#66d9ef>TF_VAR_resource_group_location</span>: $(RESOURCE_GROUP_LOCATION)
    <span style=color:#66d9ef>TF_VAR_num_windows_hosts</span>: $(NUM_WINDOWS_HOSTS)
    <span style=color:#66d9ef>TF_VAR_num_linux_hosts</span>: $(NUM_LINUX_HOSTS)
    <span style=color:#66d9ef>TF_VAR_vm_admin_username</span>: $(VM_ADMIN_USERNAME)
    <span style=color:#66d9ef>TF_VAR_vm_size</span>: $(VM_SIZE)
    <span style=color:#66d9ef>TF_VAR_vm_disk_type</span>: $(VM_DISK_TYPE)
    <span style=color:#66d9ef>TF_VAR_vm_public_access</span>: $(VM_PUBLIC_ACCESS)
    <span style=color:#66d9ef>TF_VAR_acr_sku</span>: $(ACR_SKU)
</code></pre></div><p>This pipeline may looks complex but it is just four activities:</p><ol><li>Download the file with Terraform remote configuration</li><li>Get the correct version of Terraform</li><li>Run <code>terraform init</code></li><li>Run <code>terraform apply</code></li></ol><p>Terraform <em>init</em> is the first command to run before any other meaningful command can be used: it downloads providers used in code and configures state. State must be remote (by default uses a local file) as the machine running this pipeline can change at each execution.
I used the <a href=https://www.hashicorp.com/blog/introducing-terraform-cloud-remote-state-management target=_blank rel="noopener noreferrer">recently announced
&nbsp;<i class="fas fa-external-link-alt"></i></a> Remote State Management feature of Terraform Cloud, but you can change to Azure Storage as well.
<em>apply</em> does all the heavy lifting, comparing the definitions in Terraform source code and the resources in Azure.</p><p>Wow, we have a pipeline that deploy hosts to run pipelines that deploy docker containers to run the usual build pipelines!</p><h2 id=secrets>Secrets</h2><p>One note of caution: in this example secrets and password are accessible reading environment variables and saved in clear text in TF State.</p></p></div><div class=card-footer><small class=text-muted><i class="fas fa-folder text-primary"></i>&nbsp;
<a href=/categories/#devops class="badge badge-primary"><span>DevOps</span></a><br><i class="fas fa-tags text-secondary"></i>&nbsp;
<a href=/tags/#build class="badge badge-secondary"><span>Build</span></a>
<a href=/tags/#pipelines class="badge badge-secondary"><span>Pipelines</span></a>
<a href=/tags/#azure-devops class="badge badge-secondary"><span>Azure DevOps</span></a>
<a href=/tags/#terraform class="badge badge-secondary"><span>Terraform</span></a></small></div></div><div id=disqus_thread></div><script type=application/javascript>var disqus_config=function(){};(function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById('disqus_thread').innerHTML='Disqus comments not available by default when the website is previewed locally.';return;}
var d=document,s=d.createElement('script');s.async=true;s.src='//'+"blog-casavian"+'.disqus.com/embed.js';s.setAttribute('data-timestamp',+new Date());(d.head||d.body).appendChild(s);})();</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div></main><footer class="navbar-light border-top"><div class=container><div class=row><div class="col-12 col-md-3 mb-3"><h5>Giulio Vian's Blog!</h5>Notes and considerations of small venetian guy on DevOps tools, architecture, development and other paraphernalia.</div><div class="col-12 col-md-3 mb-3"><h5>Social</h5><ul class="list-unstyled list-inline"><li class=list-inline-item><a href=https://github.com/giuliov target=_blank rel="noopener noreferrer" title=GitHub class="fab fa-github fa-2x"></a></li><li class=list-inline-item><a href=https://stackoverflow.com/users/100864 target=_blank rel="noopener noreferrer" title="Stack Overflow" class="fab fa-stack-overflow fa-2x"></a></li><li class=list-inline-item><a href=https://medium.com/@giuliovdev target=_blank rel="noopener noreferrer" title=Medium class="fab fa-medium fa-2x"></a></li><li class=list-inline-item><a href=https://linkedin.com/in/giuliovian target=_blank rel="noopener noreferrer" title=LinkedIn class="fab fa-linkedin fa-2x"></a></li><li class=list-inline-item><a href=https://linkedin.com/company/unum-ireland-ltd-it target=_blank rel="noopener noreferrer" title="LinkedIn Company" class="fab fa-linkedin fa-2x"></a></li><li class=list-inline-item><a href=https://xing.com/profile/Giulio_Vian target=_blank rel="noopener noreferrer" title=Xing class="fab fa-xing fa-2x"></a></li><li class=list-inline-item><a href=https://slideshare.net/giuliov target=_blank rel="noopener noreferrer" title=SlideShare class="fab fa-slideshare fa-2x"></a></li><li class=list-inline-item><a href=https://youtube.com/UCZ-J6JRyvz6aaJ9zCN5wpxA target=_blank rel="noopener noreferrer" title=YouTube class="fab fa-youtube fa-2x"></a></li><li class=list-inline-item><a href=https://twitter.com/giulio_vian target=_blank rel="noopener noreferrer" title=Twitter class="fab fa-twitter fa-2x"></a></li><li class=list-inline-item><a href=mailto:giulio.dev@casavian.eu title=Email class="fas fa-envelope fa-2x"></a></li></ul></div><div class="col-12 col-md-3 mb-3"><h5>Site</h5><ul class=list-unstyled><li><a href=/about/><i class="fas fa-address-card"></i>About</a></li><li><a href=/categories/><i class="fas fa-folder"></i>Categories</a></li><li><a href=/series/><i class="fas fa-book"></i>Series</a></li><li><a href=/tags/><i class="fas fa-tags"></i>Tags</a></li><li><a href=http://www.getlatestversion.eu/>Get Latest Version</a></li><li><a href=https://blogs.msdn.microsoft.com/giuliov/>Old blog</a></li></ul></div><div class="col-12 col-md-3 mb-3">&copy; 2020 Giulio Vian<br>Theme by <a href=https://www.spech.de target=_blank rel="noopener noreferrer">Sebastian Pech</a>.</div></div></div></footer><script src=/js/vendor.min.0497fa926ed3dc2241b91e016467480841da9749a0f7c40ed3960c3c238745e5accb5ec5e07654668e11047bbf96f95083b88dd49a845781011aba42e4f00a5d.js integrity="sha512-BJf6km7T3CJBuR4BZGdICEHal0mg98QO05YMPCOHReWsy17F4HZUZo4RBHu/lvlQg7iN1JqEV4EBGrpC5PAKXQ=="></script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-46796059-1','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script></body></html>