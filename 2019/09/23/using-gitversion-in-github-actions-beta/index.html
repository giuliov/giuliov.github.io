<!doctype html><html lang=en><meta charset=utf-8><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"http:\/\/blog.casavian.eu\/"},"articleSection":"post","name":"Using GitVersion in GitHub Actions beta","headline":"Using GitVersion in GitHub Actions beta","description":"Notes and considerations of small venetian guy on DevOps tools, architecture, development and other paraphernalia.","inLanguage":"en","author":"Giulio Vian","creator":"Giulio Vian","publisher":"Giulio Vian","accountablePerson":"Giulio Vian","copyrightHolder":"Giulio Vian","copyrightYear":"2019","datePublished":"2019-09-23T00:00:00Z","dateModified":"2019-09-23T00:00:00Z","url":"\/2019\/09\/23\/using-gitversion-in-github-actions-beta\/","wordCount":"981","keywords":["GitHub","GitHub Actions","GitVersion","SemVer","Semantic Versioning","Blog"]}</script><title>Using GitVersion in GitHub Actions beta &ndash; Giulio Vian's Blog!</title><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=description content="Notes and considerations of small venetian guy on DevOps tools, architecture, development and other paraphernalia."><meta name=author content="Giulio Vian"><link rel=icon href=/favicon.ico><meta itemprop=name content="Using GitVersion in GitHub Actions beta"><meta itemprop=description content="I was lucky to enter the GitHub Actions beta program so I wondered about the best way to test it. Finally, I decided to port Aggregator CLI &nbsp;  build scripts to GitHub Actions.
A critical step of those scripts is to run GitVersion &nbsp;  to generate the version for Aggregator. GitVersion, in the words of its authors, &ldquo;looks at your git history and works out the semantic version of the commit being built."><meta itemprop=datePublished content="2019-09-23T00:00:00+00:00"><meta itemprop=dateModified content="2019-09-23T00:00:00+00:00"><meta itemprop=wordCount content="981"><meta itemprop=image content="http://blog.casavian.eu/2019/09/23/using-gitversion-in-github-actions-beta/feature-FalkirkWheelSide_2004_SeanMcClean.jpg"><meta itemprop=keywords content="GitHub,GitHub Actions,GitVersion,SemVer,Semantic Versioning,"><meta property="og:title" content="Using GitVersion in GitHub Actions beta"><meta property="og:description" content="I was lucky to enter the GitHub Actions beta program so I wondered about the best way to test it. Finally, I decided to port Aggregator CLI &nbsp;  build scripts to GitHub Actions.
A critical step of those scripts is to run GitVersion &nbsp;  to generate the version for Aggregator. GitVersion, in the words of its authors, &ldquo;looks at your git history and works out the semantic version of the commit being built."><meta property="og:type" content="article"><meta property="og:url" content="http://blog.casavian.eu/2019/09/23/using-gitversion-in-github-actions-beta/"><meta property="og:image" content="http://blog.casavian.eu/2019/09/23/using-gitversion-in-github-actions-beta/feature-FalkirkWheelSide_2004_SeanMcClean.jpg"><meta property="article:published_time" content="2019-09-23T00:00:00+00:00"><meta property="article:modified_time" content="2019-09-23T00:00:00+00:00"><meta property="og:site_name" content="Giulio Vian's Blog!"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="http://blog.casavian.eu/2019/09/23/using-gitversion-in-github-actions-beta/feature-FalkirkWheelSide_2004_SeanMcClean.jpg"><meta name=twitter:title content="Using GitVersion in GitHub Actions beta"><meta name=twitter:description content="I was lucky to enter the GitHub Actions beta program so I wondered about the best way to test it. Finally, I decided to port Aggregator CLI &nbsp;  build scripts to GitHub Actions.
A critical step of those scripts is to run GitVersion &nbsp;  to generate the version for Aggregator. GitVersion, in the words of its authors, &ldquo;looks at your git history and works out the semantic version of the commit being built."><meta name=twitter:site content="@giulio_vian"><link rel=alternate href=/index.xml type=application/rss+xml title="Giulio Vian's Blog!"><link rel=stylesheet href=/css/vendor.min.95b0b4c4607aec507f0fc9d9c36a12a4613ccac06f9423caa43e265cb58eb5f90709388cc0fa166ac3ca836b4163e6d0569b8b86065d9cabdf223c5ea9a63b08.css integrity="sha512-lbC0xGB67FB/D8nZw2oSpGE8ysBvlCPKpD4mXLWOtfkHCTiMwPoWasPKg2tBY+bQVpuLhgZdnKvfIjxeqaY7CA=="><link href=http://blog.casavian.eu/css/cookieconsent.min.cd0d0b6e50ff01ff2f3a9a70d7cfb66a7c6cb9acf7a566325568be6d3bd31fc4.css rel=stylesheet type=text/css integrity="sha256-zQ0LblD/Af8vOppw18+2anxsuaz3pWYyVWi+bTvTH8Q=" crossorigin=anonymous><script src=http://blog.casavian.eu/js/cookieconsent.min.e55842a856a6d829feca3c3ad736c136b6c7549e9247274f78aa296259e06e24.js integrity="sha256-5VhCqFam2Cn+yjw61zbBNrbHVJ6SRydPeKopYlngbiQ=" crossorigin=anonymous async></script><script>window.addEventListener("load",function(){window.cookieconsent.initialise({"palette":{"popup":{"background":"#428bca","text":"#ffffff"},"button":{"background":"#f71559"}},"content":{"message":'This website uses cookies.',"dismiss":'Got it!',"link":'Learn more.',"href":"http:\/\/blog.casavian.eu\/page\/privacy-cookies-policy\/"},"position":"bottom-right"})});</script><body><nav class="navbar navbar-light bg-white navbar-expand-lg border-bottom"><div class=container><a class="navbar-brand text-primary" href=/>Giulio Vian's Blog!</a>
<button class="navbar-toggler collapsed" type=button data-toggle=collapse data-target=#navbarCollapse aria-controls=navbarCollapse aria-expanded=false aria-label="Toggle navigation">
<span class=navbar-toggler-icon></span></button><div class="navbar-collapse collapse" id=navbarCollapse><ul class="navbar-nav mr-auto"><li class=nav-item><a class="nav-link text-primary" href=/index.html><i class="fas fa-home"></i>Home</a></li><li class=nav-item><a class="nav-link text-primary" href=/page/about/><i class="fa fa-info-circle"></i>About</a></li><li class=nav-item><a class="nav-link text-primary" href=/page/public-speaking><i class="fa fa-microphone"></i>Speaking</a></li><li class=nav-item><a class="nav-link text-primary" href=/it><i class="fa fa-language"></i>Italian</a></li></ul></div></div></nav><main role=main><div class="container mt-3 mb-3"><div class=card><img class=card-img-top src=/2019/09/23/using-gitversion-in-github-actions-beta/feature-FalkirkWheelSide_2004_SeanMcClean_hua8b418b8d702b4feb9ff502e1d853715_903216_1108x0_resize_q75_box.jpg alt="Using GitVersion in GitHub Actions beta" title="Using GitVersion in GitHub Actions beta"><div class=card-body><h1 class=card-title><a href=/2019/09/23/using-gitversion-in-github-actions-beta/>Using GitVersion in GitHub Actions beta</a></h1><h6 class="card-subtitle mb-2 text-muted"><i class="fas fa-calendar-day"></i>&nbsp;23 Sep 2019 -
<i class="fas fa-user"></i>&nbsp;Giulio Vian
- <i class="fas fa-clock"></i>&nbsp;~5 Minutes</h6><p class=card-text><p>I was lucky to enter the GitHub Actions beta program so I wondered about the best way to test it.
Finally, I decided to port <a href=https://github.com/tfsaggregator/aggregator-cli target=_blank rel="noopener noreferrer">Aggregator CLI
&nbsp;<i class="fab fa-github"></i></a> build scripts to GitHub Actions.</p><p>A critical step of those scripts is to run <a href=https://github.com/GitTools/GitVersion target=_blank rel="noopener noreferrer">GitVersion
&nbsp;<i class="fab fa-github"></i></a> to generate the version for Aggregator. GitVersion, in the words of its authors,
&ldquo;<em>looks at your git history and works out the semantic version of the commit being built.</em>&rdquo;
I will spend a few more words later on the versioning topic, explaining why it is so important, but for now let&rsquo;s stick to the mechanics of running this tool.</p><p>The first issue is that GitVersion <a href=https://help.github.com/en/articles/software-in-virtual-environments-for-github-actions target=_blank rel="noopener noreferrer">is not installed
&nbsp;<i class="fas fa-external-link-alt"></i></a> on Linux GitHub agents.</p><h2 id=gitversion-not-working>GitVersion not working</h2><p>So, GitVersion is not installed and there is no existing Action for it. There is still a way:
GitHub Actions are mostly written in Javascript but they allow to run any Docker container which is published on a publicly-available Docker registry.
Fantastic! GitVersion has a both a Windows and a Linux image in Docker Hub.
Note that such Docker GitHub Action is available only on Linux agents, so the first step to use GitVersion is to require such Linux agent using the <code>runs-on</code> clause this way:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml>    <span style=color:#66d9ef>runs-on</span>: ubuntu-latest
</code></pre></div><p>The second trick was harder to discover: in my first attempts of running GitVersion, I found this error in the logs.</p><pre><code>ERROR [09/12/19 19:23:21:93] An unexpected error occurred:
System.InvalidOperationException: Could not find a 'develop' or 'master' branch, neither locally nor remotely.
  at GitVersion.Configuration.BranchConfigurationCalculator.InheritBranchConfiguration(GitVersionContext context, Branch targetBranch, BranchConfig branchConfiguration, IList`1 excludedInheritBranches)
</code></pre><p>What? Yes, I was working on a development branch, but why GitVersion cannot find <em>master</em>? I never saw this problem with other pipelines.</p><p>Well, in the log of the <strong>checkout</strong> action, after pulling the code, you see two git commands. The last command, <code>git reset --hard &lt;sha-commit-matching-triggering-event></code>, is pretty common and put the local repository in detached HEAD, so this is not causing GitVersion error.</p><p>Going backward in the log, I found a line with this command <code>git checkout --progress --force -B refs/heads/&lt;branch> refs/remotes/origin/&lt;branch></code>. Aha! This checkout materialise only the branch which triggered the event and no other.</p><p>This has a simple solution: run an explicit <code>git branch</code> to guarantee that a local <code>master</code> is available to GitVersion.</p><p>I also found that the initial <em>git pull</em> in the <strong>checkout</strong> action has an explicit <code>--no-tags</code> option. Tags are necessary to GitVersion, otherwise it may compute an incorrect version, and we need to fix this too.</p><p>In summary, I added a step in the workflow (that is the name for a build script in GitHub Actions), just after the <strong>checkout</strong> action, to put the git repository status the way GitVersion needs.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml>    - <span style=color:#66d9ef>uses</span>: actions/checkout@v1
    - <span style=color:#66d9ef>run</span>: <span style=color:#e6db74>|
</span><span style=color:#e6db74>        git fetch --tags</span>
        git branch --create-reflog master origin/master
</code></pre></div><p>With this correction the GitVersion error stops showing up.</p><h2 id=more-gitversion-tricks>More GitVersion tricks</h2><p>I have another couple of useful tips.</p><p>First is the position of the <code>UpdateAssemblyInfo</code> option: it must be the first option or the <em>AssemblyInfo</em> files are left untouched. Note also the use of a dash <code>-</code> instead of a slash <code>/</code> character to introduce an option. This is required when running GitVersion on Linux. Here is a working example:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml>    - <span style=color:#66d9ef>name</span>: Update AssemblyInfo files
      <span style=color:#66d9ef>uses</span>: docker://gittools/gitversion:<span style=color:#ae81ff>5.0.2</span>-linux
      <span style=color:#66d9ef>with</span>:
        <span style=color:#66d9ef>args</span>: <span style=color:#e6db74>&#39;-updateassemblyinfo -nocache -output buildserver&#39;</span>
</code></pre></div><p>You may wonder how the Docker container can alter the repository which is on host filesystem. Well, there is no magic: the GitHub Docker action automatically mounts the root of the repo as docker volume in a fixed directory, <code>/github/workspace</code>; it also sets <code>/github/workspace</code> as the current directory for the container. The dockerised tool acts on the current folder without realising it is touching the host filesystem.</p><p>The second tip is a technique to edit other files in addition to <em>AssemblyInfo</em> files. As GitVersion runs in a container, it is non-trivial to export the environment variables it computes. I found easier to edit the files from within the container using the <code>exec</code> option. This option runs a nested command inheriting all <a href=https://gitversion.readthedocs.io/en/latest/more-info/variables/ target=_blank rel="noopener noreferrer">environment variables
&nbsp;<i class="fas fa-external-link-alt"></i></a> just computed by GitVersion.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml>    - <span style=color:#66d9ef>name</span>: <span style=color:#e6db74>&#39;Set version in aggregator-manifest.ini&#39;</span>
      <span style=color:#66d9ef>uses</span>: docker://gittools/gitversion:<span style=color:#ae81ff>5.0.2</span>-linux
      <span style=color:#66d9ef>with</span>:
        <span style=color:#66d9ef>args</span>: <span style=color:#e6db74>&#39;-nocache -output buildserver -exec /bin/bash -execargs &#34;-c \&#34;sed -E -i \&#34;s/version=.*/version=$GitVersion_FullSemVer/\&#34; /github/workspace/src/aggregator-function/aggregator-manifest.ini\&#34;&#34;&#39;</span>
</code></pre></div><p>In this example, I simply run <a href=https://www.gnu.org/software/sed/manual/sed.html target=_blank rel="noopener noreferrer"><code>sed</code>
&nbsp;<i class="fas fa-external-link-alt"></i></a> to edit the target file using the value of <code>$GitVersion_FullSemVer</code> environment variable, kindly supplied by GitVersion, as the replacement value.</p><h2 id=why-you-should-use-gitversion-or-a-similar-tool>Why you should use GitVersion or a similar tool</h2><p>If you do not know in details what is <a href=https://semver.org/ target=_blank rel="noopener noreferrer">Semantic Versioning
&nbsp;<i class="fas fa-external-link-alt"></i></a> (SemVer) I recommend following the link to the site and study the definitions.</p><p>Is SemVer a perfect and fully automatable solution? I do not think so: much is left to human judgement. On the other hand is extremely good for tools and as a message from developers to users. A great discussion on pros and cons of SemVer can be found at <a href=https://gist.github.com/jashkenas/cbd2b088e20279ae2c8e>https://gist.github.com/jashkenas/cbd2b088e20279ae2c8e</a>.</p><p>In my opinion, you should use SemVer whenever reasonably feasible and <a href=https://github.com/GitTools/GitVersion target=_blank rel="noopener noreferrer">GitVersion
&nbsp;<i class="fab fa-github"></i></a> is a fabulous tool that makes very easy following SemVer principles. It analyses the Git repo history looking for branches and tags and, from this information, it automatically determines the semantic version applying the rules you like.</p><p>Does it reads your mind? No, you still need to apply tags or follow a pattern in your branches, but that is all you need. You still have to use your judgement and follow SemVer rules.</p><p>Even more important is that GitVersion (or any similar tool) prevents trivial mistakes, like forgetting to increase the build version, and decrease the effort of the maintainer. It will always suggest a unique set of identifiers for our artefacts and this is essential for implementing <em>traceability</em>. I preached about traceability for decades, now.
Even with Continuous Deployment it is easy to lose track of which code landed on users&rsquo; hands without basic techniques like the ones supported by GitVersion.</p><p>That&rsquo;s all for today and, as always, happy building!</p></p></div><div class=card-footer><small class=text-muted><i class="fas fa-folder text-primary"></i>&nbsp;
<a href=/categories/#devops class="badge badge-primary"><span>DevOps</span></a><br><i class="fas fa-tags text-secondary"></i>&nbsp;
<a href=/tags/#github class="badge badge-secondary"><span>GitHub</span></a>
<a href=/tags/#github-actions class="badge badge-secondary"><span>GitHub Actions</span></a>
<a href=/tags/#gitversion class="badge badge-secondary"><span>GitVersion</span></a>
<a href=/tags/#semver class="badge badge-secondary"><span>SemVer</span></a>
<a href=/tags/#semantic-versioning class="badge badge-secondary"><span>Semantic Versioning</span></a></small></div></div></div></main><footer class="navbar-light border-top"><div class=container><div class=row><div class="col-12 col-md-3 mb-3"><h5>Giulio Vian's Blog!</h5>Notes and considerations of small venetian guy on DevOps tools, architecture, development and other paraphernalia.</div><div class="col-12 col-md-3 mb-3"><h5>Social</h5><ul class="list-unstyled list-inline"><li class=list-inline-item><a href=https://github.com/giuliov target=_blank rel="noopener noreferrer" title=GitHub class="fab fa-github fa-2x"></a></li><li class=list-inline-item><a href=https://stackoverflow.com/users/100864 target=_blank rel="noopener noreferrer" title="Stack Overflow" class="fab fa-stack-overflow fa-2x"></a></li><li class=list-inline-item><a href=https://medium.com/@giuliovdev target=_blank rel="noopener noreferrer" title=Medium class="fab fa-medium fa-2x"></a></li><li class=list-inline-item><a href=https://linkedin.com/in/giuliovian target=_blank rel="noopener noreferrer" title=LinkedIn class="fab fa-linkedin fa-2x"></a></li><li class=list-inline-item><a href=https://linkedin.com/company/unum-ireland-ltd-it target=_blank rel="noopener noreferrer" title="LinkedIn Company" class="fab fa-linkedin fa-2x"></a></li><li class=list-inline-item><a href=https://xing.com/profile/Giulio_Vian target=_blank rel="noopener noreferrer" title=Xing class="fab fa-xing fa-2x"></a></li><li class=list-inline-item><a href=https://slideshare.net/giuliov target=_blank rel="noopener noreferrer" title=SlideShare class="fab fa-slideshare fa-2x"></a></li><li class=list-inline-item><a href=https://youtube.com/UCZ-J6JRyvz6aaJ9zCN5wpxA target=_blank rel="noopener noreferrer" title=YouTube class="fab fa-youtube fa-2x"></a></li><li class=list-inline-item><a href=https://twitter.com/giulio_vian target=_blank rel="noopener noreferrer" title=Twitter class="fab fa-twitter fa-2x"></a></li><li class=list-inline-item><a href=mailto:giulio.dev@casavian.eu title=Email class="fas fa-envelope fa-2x"></a></li></ul></div><div class="col-12 col-md-3 mb-3"><h5>Site</h5><ul class=list-unstyled><li><a href=/about/><i class="fas fa-address-card"></i>About</a></li><li><a href=/categories/><i class="fas fa-folder"></i>Categories</a></li><li><a href=/series/><i class="fas fa-book"></i>Series</a></li><li><a href=/tags/><i class="fas fa-tags"></i>Tags</a></li><li><a href=http://www.getlatestversion.eu/>Get Latest Version</a></li><li><a href=https://blogs.msdn.microsoft.com/giuliov/>Old blog</a></li></ul></div><div class="col-12 col-md-3 mb-3">&copy; 2020 Giulio Vian<br>Theme by <a href=https://www.spech.de target=_blank rel="noopener noreferrer">Sebastian Pech</a>.</div></div></div></footer><script src=/js/vendor.min.0497fa926ed3dc2241b91e016467480841da9749a0f7c40ed3960c3c238745e5accb5ec5e07654668e11047bbf96f95083b88dd49a845781011aba42e4f00a5d.js integrity="sha512-BJf6km7T3CJBuR4BZGdICEHal0mg98QO05YMPCOHReWsy17F4HZUZo4RBHu/lvlQg7iN1JqEV4EBGrpC5PAKXQ=="></script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-46796059-1','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script></body></html>