<!doctype html><html lang=en><meta charset=utf-8><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"http:\/\/blog.casavian.eu\/"},"articleSection":"post","name":"Increment Version for Changed Assemblies only – First part","headline":"Increment Version for Changed Assemblies only – First part","description":"Notes and considerations of small venetian guy on DevOps tools, architecture, development and other paraphernalia.","inLanguage":"en","author":"Giulio Vian","creator":"Giulio Vian","publisher":"Giulio Vian","accountablePerson":"Giulio Vian","copyrightHolder":"Giulio Vian","copyrightYear":"2014","datePublished":"2014-04-23T00:00:00Z","dateModified":"2014-04-23T00:00:00Z","url":"\/2014\/04\/23\/increment-version-for-changed-assemblies-only-first-part\/","wordCount":"721","keywords":["TFS 2013","TFS 2012","MSBuild","Build","Versioning","Blog"]}</script><title>Increment Version for Changed Assemblies only – First part &ndash; Giulio Vian's Blog!</title><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=description content="Notes and considerations of small venetian guy on DevOps tools, architecture, development and other paraphernalia."><meta name=author content="Giulio Vian"><link rel=icon href=/favicon.ico><meta itemprop=name content="Increment Version for Changed Assemblies only – First part"><meta itemprop=description content="This is something I did in the past (Build incrementale e numeri di versione [ITA] &nbsp; ), and it came out recently on Stack Overflow &nbsp; , so I will take the time to describe how to do this in details.
The solution is design around MSBuild: leveraging some extension points, you trigger the custom code that increments some version number in AssemblyInfo.cs, subject to the same conditions that triggers code compiling."><meta itemprop=datePublished content="2014-04-23T00:00:00+00:00"><meta itemprop=dateModified content="2014-04-23T00:00:00+00:00"><meta itemprop=wordCount content="721"><meta itemprop=keywords content="TFS 2013,TFS 2012,MSBuild,Build,Versioning,"><meta property="og:title" content="Increment Version for Changed Assemblies only – First part"><meta property="og:description" content="This is something I did in the past (Build incrementale e numeri di versione [ITA] &nbsp; ), and it came out recently on Stack Overflow &nbsp; , so I will take the time to describe how to do this in details.
The solution is design around MSBuild: leveraging some extension points, you trigger the custom code that increments some version number in AssemblyInfo.cs, subject to the same conditions that triggers code compiling."><meta property="og:type" content="article"><meta property="og:url" content="http://blog.casavian.eu/2014/04/23/increment-version-for-changed-assemblies-only-first-part/"><meta property="article:published_time" content="2014-04-23T00:00:00+00:00"><meta property="article:modified_time" content="2014-04-23T00:00:00+00:00"><meta property="og:site_name" content="Giulio Vian's Blog!"><meta name=twitter:card content="summary"><meta name=twitter:title content="Increment Version for Changed Assemblies only – First part"><meta name=twitter:description content="This is something I did in the past (Build incrementale e numeri di versione [ITA] &nbsp; ), and it came out recently on Stack Overflow &nbsp; , so I will take the time to describe how to do this in details.
The solution is design around MSBuild: leveraging some extension points, you trigger the custom code that increments some version number in AssemblyInfo.cs, subject to the same conditions that triggers code compiling."><meta name=twitter:site content="@giulio_vian"><link rel=alternate href=/index.xml type=application/rss+xml title="Giulio Vian's Blog!"><link rel=stylesheet href=/css/vendor.min.95b0b4c4607aec507f0fc9d9c36a12a4613ccac06f9423caa43e265cb58eb5f90709388cc0fa166ac3ca836b4163e6d0569b8b86065d9cabdf223c5ea9a63b08.css integrity="sha512-lbC0xGB67FB/D8nZw2oSpGE8ysBvlCPKpD4mXLWOtfkHCTiMwPoWasPKg2tBY+bQVpuLhgZdnKvfIjxeqaY7CA=="><link href=http://blog.casavian.eu/css/cookieconsent.min.cd0d0b6e50ff01ff2f3a9a70d7cfb66a7c6cb9acf7a566325568be6d3bd31fc4.css rel=stylesheet type=text/css integrity="sha256-zQ0LblD/Af8vOppw18+2anxsuaz3pWYyVWi+bTvTH8Q=" crossorigin=anonymous><script src=http://blog.casavian.eu/js/cookieconsent.min.e55842a856a6d829feca3c3ad736c136b6c7549e9247274f78aa296259e06e24.js integrity="sha256-5VhCqFam2Cn+yjw61zbBNrbHVJ6SRydPeKopYlngbiQ=" crossorigin=anonymous async></script><script>window.addEventListener("load",function(){window.cookieconsent.initialise({"palette":{"popup":{"background":"#428bca","text":"#ffffff"},"button":{"background":"#f71559"}},"content":{"message":'This website uses cookies.',"dismiss":'Got it!',"link":'Learn more.',"href":"http:\/\/blog.casavian.eu\/page\/privacy-cookies-policy\/"},"position":"bottom-right"})});</script><body><nav class="navbar navbar-light bg-white navbar-expand-lg border-bottom"><div class=container><a class="navbar-brand text-primary" href=/>Giulio Vian's Blog!</a>
<button class="navbar-toggler collapsed" type=button data-toggle=collapse data-target=#navbarCollapse aria-controls=navbarCollapse aria-expanded=false aria-label="Toggle navigation">
<span class=navbar-toggler-icon></span></button><div class="navbar-collapse collapse" id=navbarCollapse><ul class="navbar-nav mr-auto"><li class=nav-item><a class="nav-link text-primary" href=/index.html><i class="fas fa-home"></i>Home</a></li><li class=nav-item><a class="nav-link text-primary" href=/page/about/><i class="fa fa-info-circle"></i>About</a></li><li class=nav-item><a class="nav-link text-primary" href=/page/public-speaking><i class="fa fa-microphone"></i>Speaking</a></li><li class=nav-item><a class="nav-link text-primary" href=/it><i class="fa fa-language"></i>Italian</a></li></ul></div></div></nav><main role=main><div class="container mt-3 mb-3"><div class=card><div class=card-body><h1 class=card-title><a href=/2014/04/23/increment-version-for-changed-assemblies-only-first-part/>Increment Version for Changed Assemblies only – First part</a></h1><h6 class="card-subtitle mb-2 text-muted"><i class="fas fa-calendar-day"></i>&nbsp;23 Apr 2014 -
<i class="fas fa-user"></i>&nbsp;Giulio Vian
- <i class="fas fa-clock"></i>&nbsp;~4 Minutes</h6><p class=card-text><p>This is something I did in the past (<a href=http://blogs.msdn.com/b/giuliov/archive/2012/12/11/build-incrementale-e-numeri-di-versione.aspx target=_blank rel="noopener noreferrer">
Build incrementale e numeri di versione [ITA]
&nbsp;<i class="fas fa-external-link-alt"></i>
</a>), and it came out recently on <a href=http://stackoverflow.com/ target=_blank rel="noopener noreferrer">Stack Overflow
&nbsp;<i class="fas fa-external-link-alt"></i>
</a>, so I will take the time to describe how to do this in details.</p><p>The solution is design around MSBuild: leveraging some extension points, you trigger the custom code that increments some version number in AssemblyInfo.cs, subject to the same conditions that triggers code compiling. Being MSBuild based it will work both on a local (desktop) build, and a Team Foundation Build; you must be careful selecting the correct options for your Build Definition, otherwise it will not function. In this post we will look at the basics of inject code in the standard MSBuild process, leaving the Team Build customization for the [next post]({% post_url 2014-04-25-increment-version-for-changed-assemblies-only-second-part %}). A good discussion about what version numbers are available and the best practices to manage them can be found in <a href=http://vsarbuildguide.codeplex.com/ target=_blank rel="noopener noreferrer">Team Foundation Build Customization Guide
&nbsp;<i class="fas fa-external-link-alt"></i>
</a>. This solution will not touch any Visual Studio / MSBuild project file (<code>*.*proj</code>) nor requires any change to a build server.</p><h2 id=the-basics>The basics</h2><p>Let&rsquo;s start analyzing how to intercept the standard compile process and inject a custom Task in it. The standard .Net compile process is designed with some extension points ready to use and since .Net 2; furthermore there are some properties to easily hook the extension points in a clean way (see <a href=http://msdn.microsoft.com/en-us/library/ms366724.aspx target=_blank rel="noopener noreferrer">How to: Extend the Visual Studio Build Process
&nbsp;<i class="fas fa-external-link-alt"></i></a> and <a href=http://msdn.microsoft.com/en-us/library/bb629394.aspx target=_blank rel="noopener noreferrer">Common MSBuild Project Properties
&nbsp;<i class="fas fa-external-link-alt"></i></a> for details). Strangely, the most powerful property is <code>CustomAfterMicrosoftCommonTargets</code>: supplying the path of an MSBuild file, all targets defined in your file redefine the default ones and add more.
Let&rsquo;s see an example. Suppose you created a new Console Application project in the <code>C:\Sample</code> folder; running from the command line</p><pre><code>  MSBuild /property:CustomAfterMicrosoftCommonTargets=c:\Sample\custom.targets ConsoleApplication1.csproj
</code></pre><p>and assuming <code>custom.targets</code> contains</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-XML data-lang=XML><span style=color:#75715e>&lt;?xml version=&#34;1.0&#34; encoding=&#34;utf-8&#34;?&gt;</span>
<span style=color:#f92672>&lt;Project</span> <span style=color:#a6e22e>xmlns=</span><span style=color:#e6db74>&#34;http://schemas.microsoft.com/developer/msbuild/2003&#34;</span><span style=color:#f92672>&gt;</span>
  <span style=color:#f92672>&lt;Target</span> <span style=color:#a6e22e>Name=</span><span style=color:#e6db74>&#34;AfterCompile&#34;</span><span style=color:#f92672>&gt;</span>
    <span style=color:#f92672>&lt;Message</span> <span style=color:#a6e22e>Text=</span><span style=color:#e6db74>&#34;*TRACE* AfterCompile intercepted!&#34;</span> <span style=color:#a6e22e>Importance=</span><span style=color:#e6db74>&#34;high&#34;</span> <span style=color:#f92672>/&gt;</span>
  <span style=color:#f92672>&lt;/Target&gt;</span>
<span style=color:#f92672>&lt;/Project&gt;</span>
</code></pre></div><p>the output for the first run of the command is</p><p><figure class=image-caption><a href=/2014/04/23/increment-version-for-changed-assemblies-only-first-part/image_001.png><img loading=lazy height=366 width=1024 style=max-width:100%;height:auto srcset="/2014/04/23/increment-version-for-changed-assemblies-only-first-part/image_001_huc23ccb8f5731bb07126a2d693c3d4229_421240_500x0_resize_box_2.png 500w, /2014/04/23/increment-version-for-changed-assemblies-only-first-part/image_001_huc23ccb8f5731bb07126a2d693c3d4229_421240_800x0_resize_box_2.png 800w, /2014/04/23/increment-version-for-changed-assemblies-only-first-part/image_001.png 1200w," src=/2014/04/23/increment-version-for-changed-assemblies-only-first-part/image_001.png alt=image></a><figcaption></figcaption></figure></p><p>you see that <code>AfterCompile</code> is redefined, and is executed after compiling the project.
Rerunning the command without touching any file gives a different output, as MSBuild is smart to not recompile when source is unchanged.</p><p><figure class=image-caption><a href=/2014/04/23/increment-version-for-changed-assemblies-only-first-part/image1_001.png><img loading=lazy height=327 width=1024 style=max-width:100%;height:auto srcset="/2014/04/23/increment-version-for-changed-assemblies-only-first-part/image1_001_huf42558f74001464ec4c70a056344ef14_238987_500x0_resize_box_2.png 500w, /2014/04/23/increment-version-for-changed-assemblies-only-first-part/image1_001_huf42558f74001464ec4c70a056344ef14_238987_800x0_resize_box_2.png 800w, /2014/04/23/increment-version-for-changed-assemblies-only-first-part/image1_001.png 1200w," src=/2014/04/23/increment-version-for-changed-assemblies-only-first-part/image1_001.png alt=image></a><figcaption></figcaption></figure></p><p>Note that our custom message appears in both scenarios.</p><h2 id=msbuild-side>MSBuild side</h2><p>Now that we have seen the basics of intercepting the standard compile process, let&rsquo;s see how to leverage this technique to control the versioning.
In order to see an updated version number on the executable, we have to select a target running <em>before</em> the target which compiles the project; also it must be run <em>only</em> if the project will be compiled. For this to happen, use the <code>BeforeCompile</code> target and specify the same Inputs and outputs that the <code>CoreCompile</code> target uses, as in the following MSBuild snippet.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-XML data-lang=XML><span style=color:#f92672>&lt;Target</span>
    <span style=color:#a6e22e>Name=</span><span style=color:#e6db74>&#34;BeforeCompile&#34;</span>
    <span style=color:#a6e22e>Inputs=</span><span style=color:#e6db74>&#34;$(MSBuildAllProjects);
</span><span style=color:#e6db74>        @(Compile);                               
</span><span style=color:#e6db74>        @(_CoreCompileResourceInputs);
</span><span style=color:#e6db74>        $(ApplicationIcon);
</span><span style=color:#e6db74>        $(AssemblyOriginatorKeyFile);
</span><span style=color:#e6db74>        @(ReferencePath);
</span><span style=color:#e6db74>        @(CompiledLicenseFile);
</span><span style=color:#e6db74>        @(LinkResource);
</span><span style=color:#e6db74>        @(EmbeddedDocumentation); 
</span><span style=color:#e6db74>        $(Win32Resource);
</span><span style=color:#e6db74>        $(Win32Manifest);
</span><span style=color:#e6db74>        @(CustomAdditionalCompileInputs)&#34;</span>
    <span style=color:#a6e22e>Outputs=</span><span style=color:#e6db74>&#34;@(DocFileItem);
</span><span style=color:#e6db74>         @(IntermediateAssembly);
</span><span style=color:#e6db74>         @(_DebugSymbolsIntermediatePath);                 
</span><span style=color:#e6db74>         $(NonExistentFile);
</span><span style=color:#e6db74>         @(CustomAdditionalCompileOutputs)&#34;</span><span style=color:#f92672>&gt;</span>
    <span style=color:#75715e>&lt;!-- increment task here --&gt;</span>
<span style=color:#f92672>&lt;/Target&gt;</span>
</code></pre></div><p>The standard process computes the project inputs — source files, resources, referenced projects and DLLs — the project outputs — executables, PDBs, XML documentation files, etc — and compare the timestamps to see if outputs are out-of-date with respect to inputs. It is important to list the same set of files as CoreCompile, so MSBuild will trigger our target on the same condition used to compile the source. This code can be found in the <code>%Program Files (x86)%\MSBuild\12.0\Bin\Microsoft.CSharp.CurrentVersion.targets</code> file for MSBuild 12 (Visual Studio 2013 or later) or <code>%SystemRoot%\Microsoft.NET\Framework\v4.0.30319\Microsoft.CSharp.targets</code> (up to Visual Studio 2012 included).</p><p>Updating the Assembly version is easy thanks to the AssemblyInfo task of <a href=https://msbuildextensionpack.codeplex.com/ target=_blank rel="noopener noreferrer">MSBuild Extension Pack
&nbsp;<i class="fas fa-external-link-alt"></i>
</a>.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-XML data-lang=XML><span style=color:#f92672>&lt;ItemGroup&gt;</span>
    <span style=color:#f92672>&lt;AssemblyInfoFilesToUpdate</span> <span style=color:#a6e22e>Include=</span><span style=color:#e6db74>”$(MSBuildProjectDirectory)\Properties\AssemblyInfo.cs”/</span><span style=color:#f92672>&gt;</span>
<span style=color:#f92672>&lt;/ItemGroup&gt;</span>

<span style=color:#f92672>&lt;MSBuild.ExtensionPack.Framework.AssemblyInfo</span>
    <span style=color:#a6e22e>AssemblyInfoFiles=</span><span style=color:#e6db74>”@(AssemblyInfoFilesToUpdate)”</span>
    <span style=color:#a6e22e>AssemblyFileBuildNumberType=</span><span style=color:#e6db74>”YearWeekDay”</span>
    <span style=color:#a6e22e>AssemblyFileRevisionType=</span><span style=color:#e6db74>”AutoIncrement”</span>
    <span style=color:#a6e22e>FirstDayOfWeek=</span><span style=color:#e6db74>”Sunday”</span>
<span style=color:#f92672>/&gt;</span>
</code></pre></div><p>In this snippet we collect the AssemblyInfo file contained in the Project’s Properties folder and feed it to the Task asking to set a build number using current date and to automatically increment the revision number; major and minor are left untouched. See the Task documentation for many more options. Only two DLLs are required: <code>MSBuild.ExtensionPack.dll</code> and <code>Ionic.Zip.dll</code>.</p><p><figure class=image-caption><a href=/2014/04/23/increment-version-for-changed-assemblies-only-first-part/image2.png><img loading=lazy height=303 width=418 style=max-width:100%;height:auto srcset="/2014/04/23/increment-version-for-changed-assemblies-only-first-part/image2.png 500w," src=/2014/04/23/increment-version-for-changed-assemblies-only-first-part/image2.png alt="required DLLs"></a><figcaption></figcaption></figure></p><p>The code does not change the <code>AssemblyVersion</code> attribute: this is the most common option and in the <a href=http://vsarbuildguide.codeplex.com/ target=_blank rel="noopener noreferrer">Team Foundation Build Customization Guide
&nbsp;<i class="fas fa-external-link-alt"></i></a> you will find in depth information on the reasons.</p><p>In the <a href=http://blog.casavian.eu/2014/04/25/increment-version-for-changed-assemblies-only-second-part/>next post</a> we will see how to integrate these techniques in the Team Foundation Build process.</p></p></div><div class=card-footer><small class=text-muted><i class="fas fa-folder text-primary"></i>&nbsp;
<a href=/categories/#alm class="badge badge-primary"><span>ALM</span></a><br><i class="fas fa-tags text-secondary"></i>&nbsp;
<a href=/tags/#tfs-2013 class="badge badge-secondary"><span>TFS 2013</span></a>
<a href=/tags/#tfs-2012 class="badge badge-secondary"><span>TFS 2012</span></a>
<a href=/tags/#msbuild class="badge badge-secondary"><span>MSBuild</span></a>
<a href=/tags/#build class="badge badge-secondary"><span>Build</span></a>
<a href=/tags/#versioning class="badge badge-secondary"><span>Versioning</span></a></small></div></div><div id=disqus_thread></div><script type=application/javascript>var disqus_config=function(){};(function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById('disqus_thread').innerHTML='Disqus comments not available by default when the website is previewed locally.';return;}
var d=document,s=d.createElement('script');s.async=true;s.src='//'+"blog-casavian"+'.disqus.com/embed.js';s.setAttribute('data-timestamp',+new Date());(d.head||d.body).appendChild(s);})();</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div></main><footer class="navbar-light border-top"><div class=container><div class=row><div class="col-12 col-md-3 mb-3"><h5>Giulio Vian's Blog!</h5>Notes and considerations of small venetian guy on DevOps tools, architecture, development and other paraphernalia.</div><div class="col-12 col-md-3 mb-3"><h5>Social</h5><ul class="list-unstyled list-inline"><li class=list-inline-item><a href=https://github.com/giuliov target=_blank rel="noopener noreferrer" title=GitHub class="fab fa-github fa-2x"></a></li><li class=list-inline-item><a href=https://stackoverflow.com/users/100864 target=_blank rel="noopener noreferrer" title="Stack Overflow" class="fab fa-stack-overflow fa-2x"></a></li><li class=list-inline-item><a href=https://medium.com/@giuliovdev target=_blank rel="noopener noreferrer" title=Medium class="fab fa-medium fa-2x"></a></li><li class=list-inline-item><a href=https://linkedin.com/in/giuliovian target=_blank rel="noopener noreferrer" title=LinkedIn class="fab fa-linkedin fa-2x"></a></li><li class=list-inline-item><a href=https://linkedin.com/company/unum-ireland-ltd-it target=_blank rel="noopener noreferrer" title="LinkedIn Company" class="fab fa-linkedin fa-2x"></a></li><li class=list-inline-item><a href=https://xing.com/profile/Giulio_Vian target=_blank rel="noopener noreferrer" title=Xing class="fab fa-xing fa-2x"></a></li><li class=list-inline-item><a href=https://slideshare.net/giuliov target=_blank rel="noopener noreferrer" title=SlideShare class="fab fa-slideshare fa-2x"></a></li><li class=list-inline-item><a href=https://youtube.com/UCZ-J6JRyvz6aaJ9zCN5wpxA target=_blank rel="noopener noreferrer" title=YouTube class="fab fa-youtube fa-2x"></a></li><li class=list-inline-item><a href=https://twitter.com/giulio_vian target=_blank rel="noopener noreferrer" title=Twitter class="fab fa-twitter fa-2x"></a></li><li class=list-inline-item><a href=mailto:giulio.dev@casavian.eu title=Email class="fas fa-envelope fa-2x"></a></li></ul></div><div class="col-12 col-md-3 mb-3"><h5>Site</h5><ul class=list-unstyled><li><a href=/about/><i class="fas fa-address-card"></i>About</a></li><li><a href=/categories/><i class="fas fa-folder"></i>Categories</a></li><li><a href=/series/><i class="fas fa-book"></i>Series</a></li><li><a href=/tags/><i class="fas fa-tags"></i>Tags</a></li><li><a href=http://www.getlatestversion.eu/>Get Latest Version</a></li><li><a href=https://blogs.msdn.microsoft.com/giuliov/>Old blog</a></li></ul></div><div class="col-12 col-md-3 mb-3">&copy; 2021 Giulio Vian<br>Theme by <a href=https://www.spech.de target=_blank rel="noopener noreferrer">Sebastian Pech</a>.</div></div></div></footer><script src=/js/vendor.min.0497fa926ed3dc2241b91e016467480841da9749a0f7c40ed3960c3c238745e5accb5ec5e07654668e11047bbf96f95083b88dd49a845781011aba42e4f00a5d.js integrity="sha512-BJf6km7T3CJBuR4BZGdICEHal0mg98QO05YMPCOHReWsy17F4HZUZo4RBHu/lvlQg7iN1JqEV4EBGrpC5PAKXQ=="></script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-46796059-1','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script></body></html>