<!doctype html><html lang=en><meta charset=utf-8><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"http:\/\/blog.casavian.eu\/"},"articleSection":"post","name":"Increment Version for Changed Assemblies only – Second Part","headline":"Increment Version for Changed Assemblies only – Second Part","description":"Notes and considerations of small venetian guy on DevOps tools, architecture, development and other paraphernalia.","inLanguage":"en","author":"Giulio Vian","creator":"Giulio Vian","publisher":"Giulio Vian","accountablePerson":"Giulio Vian","copyrightHolder":"Giulio Vian","copyrightYear":"2014","datePublished":"2014-04-25T00:00:00Z","dateModified":"2014-04-25T00:00:00Z","url":"\/2014\/04\/25\/increment-version-for-changed-assemblies-only-second-part\/","wordCount":"668","keywords":["TFS 2013","TFS 2012","MSBuild","Build","Versioning","Blog"]}</script><title>Increment Version for Changed Assemblies only – Second Part &ndash; Giulio Vian's Blog!</title><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=description content="Notes and considerations of small venetian guy on DevOps tools, architecture, development and other paraphernalia."><meta name=author content="Giulio Vian"><link rel=icon href=/favicon.ico><meta itemprop=name content="Increment Version for Changed Assemblies only – Second Part"><meta itemprop=description content="In the previous post  we have seen how to hook into the MSBuild process, common to both the Visual Studio and the Team Foundation Server build processes. Now we examine how to leverage the previous achievement in the context of TFS Build.
We will examine the solution in a top-down fashion: first the build definition, than the build template, finally the MSBuild target file. The only drawback, is the lack of correlation between the version number appearing in the output assemblies with the Team Build Identifier; this will be correct with the next post ."><meta itemprop=datePublished content="2014-04-25T00:00:00+00:00"><meta itemprop=dateModified content="2014-04-25T00:00:00+00:00"><meta itemprop=wordCount content="668"><meta itemprop=keywords content="TFS 2013,TFS 2012,MSBuild,Build,Versioning,"><meta property="og:title" content="Increment Version for Changed Assemblies only – Second Part"><meta property="og:description" content="In the previous post  we have seen how to hook into the MSBuild process, common to both the Visual Studio and the Team Foundation Server build processes. Now we examine how to leverage the previous achievement in the context of TFS Build.
We will examine the solution in a top-down fashion: first the build definition, than the build template, finally the MSBuild target file. The only drawback, is the lack of correlation between the version number appearing in the output assemblies with the Team Build Identifier; this will be correct with the next post ."><meta property="og:type" content="article"><meta property="og:url" content="http://blog.casavian.eu/2014/04/25/increment-version-for-changed-assemblies-only-second-part/"><meta property="article:published_time" content="2014-04-25T00:00:00+00:00"><meta property="article:modified_time" content="2014-04-25T00:00:00+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Increment Version for Changed Assemblies only – Second Part"><meta name=twitter:description content="In the previous post  we have seen how to hook into the MSBuild process, common to both the Visual Studio and the Team Foundation Server build processes. Now we examine how to leverage the previous achievement in the context of TFS Build.
We will examine the solution in a top-down fashion: first the build definition, than the build template, finally the MSBuild target file. The only drawback, is the lack of correlation between the version number appearing in the output assemblies with the Team Build Identifier; this will be correct with the next post ."><meta name=twitter:site content="@giulio_vian"><link rel=alternate href=/index.xml type=application/rss+xml title="Giulio Vian's Blog!"><link rel=stylesheet href=/css/vendor.min.95b0b4c4607aec507f0fc9d9c36a12a4613ccac06f9423caa43e265cb58eb5f90709388cc0fa166ac3ca836b4163e6d0569b8b86065d9cabdf223c5ea9a63b08.css integrity="sha512-lbC0xGB67FB/D8nZw2oSpGE8ysBvlCPKpD4mXLWOtfkHCTiMwPoWasPKg2tBY+bQVpuLhgZdnKvfIjxeqaY7CA=="><link href=http://blog.casavian.eu/css/cookieconsent.min.cd0d0b6e50ff01ff2f3a9a70d7cfb66a7c6cb9acf7a566325568be6d3bd31fc4.css rel=stylesheet type=text/css integrity="sha256-zQ0LblD/Af8vOppw18+2anxsuaz3pWYyVWi+bTvTH8Q=" crossorigin=anonymous><script src=http://blog.casavian.eu/js/cookieconsent.min.e55842a856a6d829feca3c3ad736c136b6c7549e9247274f78aa296259e06e24.js integrity="sha256-5VhCqFam2Cn+yjw61zbBNrbHVJ6SRydPeKopYlngbiQ=" crossorigin=anonymous async></script><script>window.addEventListener("load",function(){window.cookieconsent.initialise({"palette":{"popup":{"background":"#428bca","text":"#ffffff"},"button":{"background":"#f71559"}},"content":{"message":'This website uses cookies.',"dismiss":'Got it!',"link":'Learn more.',"href":"http:\/\/blog.casavian.eu\/page\/privacy-cookies-policy\/"},"position":"bottom-right"})});</script><body><nav class="navbar navbar-light bg-white navbar-expand-lg border-bottom"><div class=container><a class="navbar-brand text-primary" href=/>Giulio Vian's Blog!</a>
<button class="navbar-toggler collapsed" type=button data-toggle=collapse data-target=#navbarCollapse aria-controls=navbarCollapse aria-expanded=false aria-label="Toggle navigation">
<span class=navbar-toggler-icon></span></button><div class="navbar-collapse collapse" id=navbarCollapse><ul class="navbar-nav mr-auto"><li class=nav-item><a class="nav-link text-primary" href=/index.html><i class="fas fa-home"></i>Home</a></li><li class=nav-item><a class="nav-link text-primary" href=/page/about/><i class="fa fa-info-circle"></i>About</a></li><li class=nav-item><a class="nav-link text-primary" href=/page/public-speaking><i class="fa fa-microphone"></i>Speaking</a></li></ul></div></div></nav><main role=main><div class="container mt-3 mb-3"><div class=card><div class=card-body><h1 class=card-title><a href=/2014/04/25/increment-version-for-changed-assemblies-only-second-part/>Increment Version for Changed Assemblies only – Second Part</a></h1><h6 class="card-subtitle mb-2 text-muted"><i class="fas fa-calendar-day"></i>&nbsp;25 Apr 2014 -
<i class="fas fa-user"></i>&nbsp;Giulio Vian
- <i class="fas fa-clock"></i>&nbsp;~4 Minutes</h6><p class=card-text><p>In the <a href=http://blog.casavian.eu/2014/04/23/increment-version-for-changed-assemblies-only-first-part/>previous post</a> we have seen how to hook into the MSBuild process, common to both the Visual Studio and the Team Foundation Server build processes. Now we examine how to leverage the previous achievement in the context of TFS Build.</p><p>We will examine the solution in a top-down fashion: first the build definition, than the build template, finally the MSBuild target file. The only drawback, is the lack of correlation between the version number appearing in the output assemblies with the Team Build Identifier; this will be correct with the <a href=http://blog.casavian.eu/2014/04/28/increment-version-for-changed-assemblies-only-third-part/>next post
</a>.</p><p>Please note that this solution works only on-premises, i.e. it is not applicable to Visual Studio Online.</p><h2 id=incremental-build>Incremental build</h2><p>The default Team Build process template remove all files from the workspace — i.e. the local folder on the server running the Build Agent used for a Build Definition — and get the latest version from version control. This means that all source files get a new timestamp and the binaries are deleted also: everything will be re-compiled again.</p><p>This behavior is controlled by some properties: <em>Clean workspace</em> (TFVC), <em>Clean repository</em> (Git) and <em>Clean build</em>. The first two, when the value is <strong>False</strong>, only the changed files get refreshed from version control. The latter, <em>Clean build</em>, when the value is <strong>False</strong>, you get the same behavior as Visual Studio, also called incremental building: only the changed projects will recompile.</p><p><img src=/images/image_thumb4.png alt=image></p><p>Sadly the <em>Clean workspace</em> (TFVC), <em>Clean repository</em> (Git) setting has no effect if you use the <a href=http://tfs.visualstudio.com/en-us/learn/build/hosted-build-controller-in-vs/ target=_blank rel="noopener noreferrer">Hosted Build Controller
&nbsp;<i class="fas fa-external-link-alt"></i>
</a>, that is Visual Studio Online. In this case, you get a new working directory with each build (cf. <a href=http://msdn.microsoft.com/en-us/library/dd647547.aspx#get target=_blank rel="noopener noreferrer">Get your code
&nbsp;<i class="fas fa-external-link-alt"></i>
</a>).</p><p>In TFS 2010/2 the behavior is controlled by a single property, <em>Clean Workspace</em>, with three possible values: <em>All</em>, <em>Outputs</em> and <strong>None</strong>. This latter means: don&rsquo;t delete anything and get only the changes from Version Control (see <a href=http://www.woodwardweb.com/vsts/tfs/incremental_bui.html target=_blank rel="noopener noreferrer">Incremental Builds with TFS 2010
&nbsp;<i class="fas fa-external-link-alt"></i></a> for more details).</p><h2 id=hooking-into-msbuild-from-the-build-template>Hooking into MSBuild from the Build Template</h2><p>To extend the standard MSBuild process we must pass it the full path to a file containing our custom code. It happens that this path is determined by three factors: the Build Agent selected, the Agent Working Directory and the mapping imposed by the Build Definition. Shortly, the path is dynamic and must be determined while building.</p><p>But… TFS 2013 has a nice new feature, some useful environment variables, described at <a href=http://msdn.microsoft.com/en-us/library/hh850448.aspx target=_blank rel="noopener noreferrer">Team Foundation Build environment variables
&nbsp;<i class="fas fa-external-link-alt"></i>
</a>. Stay assured that these variables are available throughout the whole process and not just when lunching a script. In particular you can use them in composing the MSBuild arguments, as in this snippet.</p><pre><code>/p:CustomAfterMicrosoftCommonTargets=&quot;$(TF_BUILD_SOURCESDIRECTORY)\BuildSample.AutoIncr\BuildTemplate\autoIncrTfs2013.targets&quot;
</code></pre><p>The TF_BUILD_SOURCESDIRECTORY represents the directory where the source code is downloaded from version control to the Build Agent local disk.</p><p>So the overall parameters to set in the Build Definitions are, at least, four. We will use the fifth, Build number format, later on.</p><p><img src=/images/2014-04-12_182207-b_thumb.png alt=2014-04-12_182207-b></p><p>The path used in the MSBuild arguments must match the relative path in version control and the mapping used in the Build Definition.</p><p><img src=/images/image_thumb5.png alt=image></p><p><img src=/images/image_thumb6.png alt=image></p><p>Note that the <code>autoIncrTfs2013.targets</code> file sits in the same version control folder as the <a href=https://msbuildextensionpack.codeplex.com/ target=_blank rel="noopener noreferrer">MSBuild Extension Pack
&nbsp;<i class="fas fa-external-link-alt"></i></a> DLLs.</p><p>At last, we can take a look at the content of <code>autoIncrTfs2013.targets</code>. It replace the <code>BeforeCompile</code> target, conveniently triggered by input and output dependencies.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-XML data-lang=XML><span style=color:#75715e>&lt;?xml version=&#34;1.0&#34; encoding=&#34;utf-8&#34;?&gt;</span>
<span style=color:#f92672>&lt;Project</span> <span style=color:#a6e22e>xmlns=</span><span style=color:#e6db74>&#34;http://schemas.microsoft.com/developer/msbuild/2003&#34;</span><span style=color:#f92672>&gt;</span>

    <span style=color:#75715e>&lt;!-- assume the DLL is in the same folder as this Targets file --&gt;</span>
    <span style=color:#f92672>&lt;UsingTask</span>
    <span style=color:#a6e22e>AssemblyFile=</span><span style=color:#e6db74>&#34;$(MSBuildThisFileDirectory)\MSBuild.ExtensionPack.dll&#34;</span>
    <span style=color:#a6e22e>TaskName=</span><span style=color:#e6db74>&#34;MSBuild.ExtensionPack.Framework.AssemblyInfo&#34;</span><span style=color:#f92672>/&gt;</span>
    
    <span style=color:#f92672>&lt;Target</span>
        <span style=color:#a6e22e>Name=</span><span style=color:#e6db74>&#34;BeforeCompile&#34;</span>
        <span style=color:#a6e22e>Inputs=</span><span style=color:#e6db74>&#34;$(MSBuildAllProjects);
</span><span style=color:#e6db74>                @(Compile); 
</span><span style=color:#e6db74>                @(_CoreCompileResourceInputs);
</span><span style=color:#e6db74>                $(ApplicationIcon);
</span><span style=color:#e6db74>                $(AssemblyOriginatorKeyFile);
</span><span style=color:#e6db74>                @(ReferencePath);
</span><span style=color:#e6db74>                @(CompiledLicenseFile);
</span><span style=color:#e6db74>                @(LinkResource);
</span><span style=color:#e6db74>                @(EmbeddedDocumentation); 
</span><span style=color:#e6db74>                $(Win32Resource);
</span><span style=color:#e6db74>                $(Win32Manifest);
</span><span style=color:#e6db74>                @(CustomAdditionalCompileInputs)&#34;</span>
                <span style=color:#a6e22e>Outputs=</span><span style=color:#e6db74>&#34;@(DocFileItem);
</span><span style=color:#e6db74>                @(IntermediateAssembly);
</span><span style=color:#e6db74>                @(_DebugSymbolsIntermediatePath); 
</span><span style=color:#e6db74>                $(NonExistentFile);
</span><span style=color:#e6db74>                @(CustomAdditionalCompileOutputs)&#34;</span>
        <span style=color:#a6e22e>DependsOnTargets=</span><span style=color:#e6db74>&#34;$(BeforeCompileDependsOn)&#34;</span><span style=color:#f92672>&gt;</span>
    
    <span style=color:#f92672>&lt;ItemGroup&gt;</span>
        <span style=color:#f92672>&lt;AssemblyInfoFiles</span> <span style=color:#a6e22e>Include=</span><span style=color:#e6db74>&#34;$(MSBuildProjectDirectory)\Properties\AssemblyInfo.cs&#34;</span><span style=color:#f92672>/&gt;</span>
    <span style=color:#f92672>&lt;/ItemGroup&gt;</span>
    
    <span style=color:#f92672>&lt;MSBuild.ExtensionPack.Framework.AssemblyInfo</span>
        <span style=color:#a6e22e>AssemblyInfoFiles=</span><span style=color:#e6db74>&#34;@(AssemblyInfoFiles)&#34;</span>
        <span style=color:#a6e22e>AssemblyFileBuildNumberType=</span><span style=color:#e6db74>&#34;YearWeekDay&#34;</span>
        <span style=color:#a6e22e>AssemblyFileRevisionType=</span><span style=color:#e6db74>&#34;AutoIncrement&#34;</span>
        <span style=color:#a6e22e>FirstDayOfWeek=</span><span style=color:#e6db74>&#34;Sunday&#34;</span>
    <span style=color:#f92672>/&gt;</span>
    
    <span style=color:#f92672>&lt;/Target&gt;</span>
<span style=color:#f92672>&lt;/Project&gt;</span>
</code></pre></div><p>The AssemblyInfo task set the File version using the current date for the build and incrementing the revision number. Note the <code>MSBuildThisFileDirectory</code> property that refers to the same folder where is located the <code>autoIncrTfs2013.targets</code> file.</p><p><a href=http://blog.casavian.eu/2014/04/28/increment-version-for-changed-assemblies-only-third-part/>Next time</a> we will see how to synchronize the version number appearing in the assemblies with the Build Identifier: for this we have to customize the Build Template.</p></p></div><div class=card-footer><small class=text-muted><i class="fas fa-folder text-primary"></i>&nbsp;
<a href=/categories/#alm class="badge badge-primary"><span>ALM</span></a><br><i class="fas fa-tags text-secondary"></i>&nbsp;
<a href=/tags/#tfs-2013 class="badge badge-secondary"><span>TFS 2013</span></a>
<a href=/tags/#tfs-2012 class="badge badge-secondary"><span>TFS 2012</span></a>
<a href=/tags/#msbuild class="badge badge-secondary"><span>MSBuild</span></a>
<a href=/tags/#build class="badge badge-secondary"><span>Build</span></a>
<a href=/tags/#versioning class="badge badge-secondary"><span>Versioning</span></a></small></div></div></div></main><footer class="navbar-light border-top"><div class=container><div class=row><div class="col-12 col-md-3 mb-3"><h5>Giulio Vian's Blog!</h5>Notes and considerations of small venetian guy on DevOps tools, architecture, development and other paraphernalia.</div><div class="col-12 col-md-3 mb-3"><h5>Social</h5><ul class="list-unstyled list-inline"><li class=list-inline-item><a href=https://github.com/giuliov target=_blank rel="noopener noreferrer" title=GitHub class="fab fa-github fa-2x"></a></li><li class=list-inline-item><a href=https://stackoverflow.com/users/100864 target=_blank rel="noopener noreferrer" title="Stack Overflow" class="fab fa-stack-overflow fa-2x"></a></li><li class=list-inline-item><a href=https://medium.com/@giuliovdev target=_blank rel="noopener noreferrer" title=Medium class="fab fa-medium fa-2x"></a></li><li class=list-inline-item><a href=https://linkedin.com/in/giuliovian target=_blank rel="noopener noreferrer" title=LinkedIn class="fab fa-linkedin fa-2x"></a></li><li class=list-inline-item><a href=https://linkedin.com/company/unum-ireland-ltd-it target=_blank rel="noopener noreferrer" title="LinkedIn Company" class="fab fa-linkedin fa-2x"></a></li><li class=list-inline-item><a href=https://xing.com/profile/Giulio_Vian target=_blank rel="noopener noreferrer" title=Xing class="fab fa-xing fa-2x"></a></li><li class=list-inline-item><a href=https://slideshare.net/giuliov target=_blank rel="noopener noreferrer" title=SlideShare class="fab fa-slideshare fa-2x"></a></li><li class=list-inline-item><a href=https://youtube.com/UCZ-J6JRyvz6aaJ9zCN5wpxA target=_blank rel="noopener noreferrer" title=YouTube class="fab fa-youtube fa-2x"></a></li><li class=list-inline-item><a href=https://twitter.com/giulio_vian target=_blank rel="noopener noreferrer" title=Twitter class="fab fa-twitter fa-2x"></a></li><li class=list-inline-item><a href=mailto:giulio.dev@casavian.eu title=Email class="fas fa-envelope fa-2x"></a></li></ul></div><div class="col-12 col-md-3 mb-3"><h5>Site</h5><ul class=list-unstyled><li><a href=/about/><i class="fas fa-address-card"></i>About</a></li><li><a href=/categories/><i class="fas fa-folder"></i>Categories</a></li><li><a href=/tags/><i class="fas fa-tags"></i>Tags</a></li></ul></div><div class="col-12 col-md-3 mb-3">&copy; 2020 Giulio Vian<br>Theme by <a href=https://www.spech.de target=_blank rel="noopener noreferrer">Sebastian Pech</a>.</div></div></div></footer><script src=/js/vendor.min.0497fa926ed3dc2241b91e016467480841da9749a0f7c40ed3960c3c238745e5accb5ec5e07654668e11047bbf96f95083b88dd49a845781011aba42e4f00a5d.js integrity="sha512-BJf6km7T3CJBuR4BZGdICEHal0mg98QO05YMPCOHReWsy17F4HZUZo4RBHu/lvlQg7iN1JqEV4EBGrpC5PAKXQ=="></script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-46796059-1','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script></body></html>